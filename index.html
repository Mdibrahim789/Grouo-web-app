<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UU EEE Dashboard | Professor X</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        /* --- THEME VARIABLES --- */
        :root {
            --sidebar-bg: #0f172a;
            --sidebar-hover: #1e293b;
            --active-bg: #f59e0b;       /* Amber/Orange Highlight */
            --active-text: #000000;
            --text-muted: #94a3b8;
            --text-light: #ffffff;
            --bg-body: #f1f5f9;
            --card-bg: #ffffff;
            --success: #22c55e;
            --danger: #ef4444;
        }

        * { box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; margin: 0; padding: 0; background: var(--bg-body); color: #333; height: 100vh; overflow: hidden; display: flex; }

        /* --- SIDEBAR UI --- */
        .sidebar {
            width: 260px;
            background: var(--sidebar-bg);
            color: white;
            display: flex;
            flex-direction: column;
            padding: 20px;
            transition: transform 0.3s ease;
            z-index: 1000;
            flex-shrink: 0;
        }

        .brand {
            display: flex; align-items: center; gap: 10px;
            font-size: 1.5rem; font-weight: 800; margin-bottom: 30px; color: var(--text-light);
        }
        .brand i { color: var(--active-bg); }

        .nav-links { flex: 1; list-style: none; padding: 0; margin: 0; overflow-y: auto; }
        .nav-item {
            display: flex; align-items: center; padding: 12px 15px; margin-bottom: 8px;
            border-radius: 8px; color: var(--text-muted); cursor: pointer; transition: 0.2s;
            font-weight: 600; font-size: 0.95rem;
        }
        .nav-item i { width: 25px; font-size: 1.1rem; }
        .nav-item:hover { background: var(--sidebar-hover); color: var(--text-light); }
        .nav-item.active {
            background: var(--active-bg); color: var(--active-text);
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
        }

        .sidebar-footer { margin-top: auto; padding-top: 20px; border-top: 1px solid #334155; }
        .admin-box {
            background: rgba(255,255,255,0.05); border-radius: 8px; padding: 12px;
            text-align: center; cursor: pointer; border: 1px solid transparent; transition: 0.3s;
        }
        .admin-box.active-mode {
            background: rgba(245, 158, 11, 0.1); border-color: var(--active-bg); color: var(--active-bg);
        }
        
        .sync-status {
            display: flex; align-items: center; gap: 8px; font-size: 0.75rem;
            color: var(--text-muted); margin-top: 15px; font-weight: 600; text-transform: uppercase;
        }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--danger); }
        .status-dot.online { background: var(--success); }

        /* --- MAIN CONTENT --- */
        .main-content { flex: 1; height: 100vh; overflow-y: auto; position: relative; background: var(--bg-body); }

        .mobile-header {
            display: none; background: var(--sidebar-bg); color: white; padding: 15px;
            align-items: center; justify-content: flex-start; gap: 20px;
            position: sticky; top: 0; z-index: 99;
        }

        .content-area { padding: 30px; max-width: 1000px; margin: 0 auto; padding-bottom: 120px; }

        .section-title { font-size: 1.5rem; color: #1e293b; margin-bottom: 20px; border-bottom: 2px solid #e2e8f0; padding-bottom: 10px; }
        .content-section { display: none; animation: fadeUp 0.3s ease; }
        .content-section.active-section { display: block; }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .card { background: var(--card-bg); padding: 20px; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; }
        
        .admin-form { display: none; background: #fff; padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #cbd5e1; }
        .admin-form input, .admin-form select, .admin-form textarea { width: 100%; padding: 10px; margin: 8px 0; border: 1px solid #cbd5e1; border-radius: 6px; }
        .admin-form button { background: var(--active-bg); color: black; font-weight: bold; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; margin-top: 10px; width: 100%; }

        table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; margin-bottom: 20px; }
        th { background: #f8fafc; text-align: left; padding: 12px; font-size: 0.85rem; color: #64748b; text-transform: uppercase; }
        td { padding: 12px; border-bottom: 1px solid #f1f5f9; }

        .att-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; margin-bottom: 15px; }
        .att-student { background: white; border: 1px solid #e2e8f0; padding: 15px; border-radius: 8px; text-align: center; cursor: pointer; transition: 0.2s; }
        .att-student.present { background: #dcfce7; border-color: #22c55e; color: #166534; font-weight: bold; }

        /* --- AI WAVE ANIMATION --- */
        .wave { width: 4px; background: #6366f1; border-radius: 2px; animation: waveAnim 1s infinite ease-in-out; }
        .wave:nth-child(2) { animation-delay: 0.1s; background: #818cf8; }
        .wave:nth-child(3) { animation-delay: 0.2s; background: #a5b4fc; }
        .wave:nth-child(4) { animation-delay: 0.3s; background: #6366f1; }
        .wave:nth-child(5) { animation-delay: 0.4s; background: #818cf8; }
        @keyframes waveAnim { 0%, 100% { height: 5px; } 50% { height: 25px; } }
        
        /* Chat Scrollbar */
        #chat-body::-webkit-scrollbar { width: 5px; }
        #chat-body::-webkit-scrollbar-thumb { background: #334155; border-radius: 5px; }

        /* --- RESPONSIVE --- */
        @media (max-width: 768px) {
            body { flex-direction: column; }
            .sidebar { 
                position: fixed; top: 0; left: 0; height: 100%; transform: translateX(-100%); 
                width: 280px; box-shadow: 5px 0 15px rgba(0,0,0,0.3);
            }
            .sidebar.open { transform: translateX(0); }
            .mobile-header { display: flex; }
            .content-area { padding: 15px; padding-bottom: 120px; }
            .overlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:998;}
            .overlay.active { display: block; }
        }
    </style>
</head>
<body>

    <div class="overlay" onclick="toggleSidebar()"></div>

    <nav class="sidebar" id="sidebar">
        <div class="brand">
            <i class="fa-solid fa-bolt"></i> UU EEE
        </div>

        <ul class="nav-links">
            <li class="nav-item active" onclick="showSection('home')" id="btn-home"><i class="fa-solid fa-house"></i> Dashboard</li>
            <li class="nav-item" onclick="showSection('academic')" id="btn-academic"><i class="fa-solid fa-book-open"></i> Academic</li>
            <li class="nav-item" onclick="showSection('students')" id="btn-students"><i class="fa-solid fa-users"></i> Students</li>
            <li class="nav-item" onclick="showSection('teachers')" id="btn-teachers"><i class="fa-solid fa-chalkboard-user"></i> Faculty</li>
            <li class="nav-item" onclick="showSection('notice')" id="btn-notice"><i class="fa-solid fa-bullhorn"></i> Notices</li>
            <li class="nav-item" onclick="showSection('attendance')" id="btn-attendance"><i class="fa-solid fa-clipboard-check"></i> Attendance</li>
            <li class="nav-item" onclick="showSection('polls')" id="btn-polls"><i class="fa-solid fa-square-poll-vertical"></i> Polls</li>
        </ul>

        <div class="sidebar-footer">
            <div class="admin-box" id="admin-btn" onclick="toggleAdminMode()">
                <i class="fa-solid fa-lock"></i> <span>Enable Admin</span>
            </div>
            <div class="sync-status">
                <div class="status-dot" id="sync-dot"></div>
                <span id="sync-text">Connecting...</span>
            </div>
        </div>
    </nav>

    <div class="main-content">
        <div class="mobile-header">
            <i class="fa-solid fa-bars" style="font-size:1.5rem; cursor:pointer;" onclick="toggleSidebar()"></i>
            <div style="font-weight:bold; display:flex; gap:10px; align-items:center;">
                <i class="fa-solid fa-bolt" style="color:#f59e0b;"></i> UU EEE
            </div>
        </div>

        <div class="content-area">
            
            <div id="home" class="content-section active-section">
                <h2 class="section-title">üëã Welcome Batch 2026</h2>
                <div id="activity-feed"></div>

                <h3 style="margin-top:30px;">üìÖ Class Routine</h3>
                <div class="admin-form">
                    <input type="text" id="r-day" placeholder="Day (e.g. Sunday)">
                    <input type="text" id="r-sub" placeholder="Subject">
                    <input type="text" id="r-room" placeholder="Room">
                    <button onclick="addRoutine()">‚ûï Add Class</button>
                </div>
                <div style="overflow-x:auto;">
                    <table id="routine-table"><thead><tr><th>Day</th><th>Subject</th><th>Room</th><th class="action-col">Act</th></tr></thead><tbody id="routine-body"></tbody></table>
                </div>
            </div>

            <div id="academic" class="content-section">
                <h2 class="section-title">üìò Academic Resources</h2>
                <div class="admin-form">
                    <h3>Add Course</h3>
                    <input type="text" id="sub-name" placeholder="Name">
                    <input type="text" id="sub-code" placeholder="Code">
                    <input type="text" id="sub-link" placeholder="Syllabus Link">
                    <button onclick="addSubject()">Add Course</button>
                </div>
                <div id="course-list"></div>
                <h3 style="margin-top:30px">üìö Files & Links</h3>
                <div class="admin-form">
                    <input type="text" id="res-title" placeholder="Title">
                    <input type="text" id="res-url" placeholder="URL">
                    <button onclick="addResource()">Add Resource</button>
                </div>
                <div id="resource-list"></div>
            </div>

            <div id="students" class="content-section">
                <h2 class="section-title">üë• Student Profiles</h2>
                <div class="admin-form" id="student-form">
                    <label style="font-weight:bold; font-size:0.9rem;">Profile Picture (Auto Compressed)</label>
                    <input type="file" id="s-img-file" accept="image/*">
                    <input type="text" id="s-name" placeholder="Name">
                    <input type="text" id="s-id" placeholder="ID">
                    <input type="text" id="s-dip" placeholder="Diploma Session (e.g. 2021-22)">
                    <input type="text" id="s-phone" placeholder="Phone">
                    <button id="btn-student-action" onclick="handleStudentSubmit()">Add Student</button>
                    <button onclick="resetStudentForm()" style="background:#64748b; margin-top:5px;">Cancel</button>
                </div>
                <div id="student-list"></div>
            </div>

            <div id="teachers" class="content-section">
                <h2 class="section-title">üë®‚Äçüè´ Faculty Members</h2>
                <div class="admin-form" id="teacher-form">
                    <label style="font-weight:bold; font-size:0.9rem;">Profile Picture</label>
                    <input type="file" id="t-img-file" accept="image/*">
                    <input type="text" id="t-name" placeholder="Name">
                    <input type="text" id="t-post" placeholder="Designation">
                    <input type="text" id="t-phone" placeholder="Phone">
                    <button onclick="handleTeacherSubmit()">Add Faculty</button>
                </div>
                <div id="teacher-list"></div>
            </div>

            <div id="notice" class="content-section">
                <h2 class="section-title">üîî Notice Board</h2>
                <div class="admin-form">
                    <input type="date" id="n-date">
                    <input type="text" id="n-title" placeholder="Title">
                    <textarea id="n-desc" placeholder="Details"></textarea>
                    <button onclick="addNotice()">Post Notice</button>
                </div>
                <div id="notice-list"></div>
            </div>

            <div id="attendance" class="content-section">
                <h2 class="section-title">üìù Take Attendance</h2>
                <div class="admin-form" style="display:block !important;"> 
                    <div id="att-controls" style="display:none;"> 
                        <input type="date" id="att-date">
                        <input type="text" id="att-subject" placeholder="Subject Name">
                        <div style="display:flex; gap:10px; margin:10px 0;">
                            <button onclick="selectAllAtt(true)" style="background:#334155; color:white; font-size:0.8rem; width:auto;">All Present</button>
                            <button onclick="selectAllAtt(false)" style="background:#334155; color:white; font-size:0.8rem; width:auto;">Clear</button>
                        </div>
                        <div id="attendance-grid" class="att-grid"></div>
                        <button onclick="saveAttendance()">üíæ Save Record</button>
                        <hr>
                    </div>
                    <h3>üìú History</h3>
                    <div id="attendance-history"></div>
                </div>
            </div>

             <div id="polls" class="content-section">
                <h2 class="section-title">üó≥Ô∏è Voting & Polls</h2>
                <div class="admin-form">
                    <input type="text" id="poll-quest" placeholder="Question">
                    <textarea id="poll-opts" placeholder="Options (comma separated)"></textarea>
                    <button onclick="addPoll()">Create Poll</button>
                </div>
                <div id="poll-list"></div>
            </div>

        </div>
    </div>

    <button onclick="openAI()" style="position:fixed; bottom:30px; right:30px; width:65px; height:65px; border-radius:50%; background:#f59e0b; border:none; box-shadow:0 4px 20px rgba(245, 158, 11, 0.5); z-index:10000; cursor:pointer; display:flex; align-items:center; justify-content:center; transition: transform 0.2s;">
        <i class="fa-solid fa-microphone" style="font-size:1.8rem; color:#0f172a;"></i>
    </button>

    <div id="ai-modal" style="display:none; position:fixed; bottom:100px; right:30px; width:380px; height:600px; background:#0f172a; border-radius:20px; box-shadow:0 10px 40px rgba(0,0,0,0.6); z-index:9999; flex-direction:column; overflow:hidden; border:1px solid #1e293b; font-family: 'Inter', sans-serif;">
        
        <div style="background:#1e293b; padding:15px 20px; display:flex; align-items:center; justify-content:space-between; border-bottom:1px solid #334155;">
            <div style="display:flex; align-items:center; gap:10px;">
                <div style="width:10px; height:10px; background:#22c55e; border-radius:50%; box-shadow:0 0 5px #22c55e;"></div>
                <span style="color:white; font-weight:700; letter-spacing:1px; font-size:0.9rem;">PROFESSOR X</span>
            </div>
            <i class="fa-solid fa-xmark" onclick="closeAI()" style="color:#94a3b8; cursor:pointer; font-size:1.2rem;"></i>
        </div>

        <div id="chat-body" style="flex:1; padding:20px; overflow-y:auto; position:relative; background: radial-gradient(circle at center, #1e293b 0%, #0f172a 70%);">
            
            <div id="ai-placeholder" style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); text-align:center; width:100%;">
                <div onclick="startListening()" style="width:80px; height:80px; border-radius:50%; background:rgba(255,255,255,0.05); display:flex; align-items:center; justify-content:center; margin:0 auto 15px; border:1px solid rgba(255,255,255,0.1); cursor:pointer;">
                    <i class="fa-solid fa-microphone" style="font-size:2rem; color:#64748b;"></i>
                </div>
                <p style="color:#64748b; font-size:0.8rem; font-weight:600; letter-spacing:1px;">AWAITING INPUT...</p>
            </div>

            <div id="ai-messages" style="display:flex; flex-direction:column; gap:15px; padding-bottom:20px;"></div>
        </div>

        <div style="background:#0b1120; padding:15px; border-top:1px solid #1e293b;">
            
            <div id="wave-box" style="height:30px; display:flex; align-items:flex-end; justify-content:center; gap:3px; margin-bottom:15px; opacity:0; transition:0.3s;">
                <div class="wave" style="height:10px;"></div><div class="wave" style="height:20px;"></div>
                <div class="wave" style="height:15px;"></div><div class="wave" style="height:25px;"></div>
                <div class="wave" style="height:10px;"></div><div class="wave" style="height:20px;"></div>
                <div class="wave" style="height:15px;"></div><div class="wave" style="height:10px;"></div>
            </div>

            <div style="display:flex; gap:10px;">
                <input type="text" id="ai-input" placeholder="Message Professor X..." 
                    onkeypress="if(event.key==='Enter') sendText()"
                    style="flex:1; background:#1e293b; border:1px solid #334155; padding:12px 15px; border-radius:12px; color:white; outline:none; font-size:0.9rem;">
                
                <button onclick="sendText()" style="width:45px; height:45px; border-radius:12px; background:#f59e0b; border:none; cursor:pointer; color:#0f172a; display:flex; align-items:center; justify-content:center;">
                    <i class="fa-solid fa-paper-plane" style="font-size:1.1rem;"></i>
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIG ---
        const BIN_ID = "696df6b5ae596e708fe62a8b"; 
        const MASTER_KEY = "$2a$10$e0AwKK3h1YV3/kmqFxYITOPhqzvyD6OoCaTUZ6PzcRBfWJwpQInOW";
        const GEMINI_API_KEY = "AIzaSyDKNDujxPXZugL42Z_fSj7Jlf-IkmRLv_w"; 

        // --- STATE ---
        let data = { routine:[], student:[], teacher:[], notice:[], attendance:[], polls:[], resources:[], subjects:[], marks:{} };
        let isAdmin = false;
        let tempAttendance = new Set();

        // --- IMAGE COMPRESSION ---
        function compressImage(file, callback) {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = event => {
                const img = new Image();
                img.src = event.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const MAX_WIDTH = 600; 
                    const scaleSize = MAX_WIDTH / img.width;
                    if (img.width > MAX_WIDTH) {
                        canvas.width = MAX_WIDTH;
                        canvas.height = img.height * scaleSize;
                    } else {
                        canvas.width = img.width;
                        canvas.height = img.height;
                    }
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
                    callback(dataUrl);
                }
            }
        }

        // --- DATA HANDLERS ---
        async function fetchData() {
            updateSyncStatus('loading');
            try {
                let res = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, { headers: { "X-Master-Key": MASTER_KEY } });
                if(!res.ok) throw new Error("API Error");
                let json = await res.json();
                let d = json.record;
                // Safe assign
                data.routine = d.routine || [];
                data.student = d.student || [];
                data.teacher = d.teacher || [];
                data.notice = d.notice || [];
                data.attendance = d.attendance || [];
                data.polls = d.polls || [];
                data.resources = d.resources || [];
                data.subjects = d.subjects || [];
                data.marks = d.marks || {};
                renderAll();
                updateSyncStatus('success');
            } catch(e) { updateSyncStatus('fail'); }
        }

        async function saveData() {
            updateSyncStatus('loading');
            try {
                await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, { 
                    method: "PUT", 
                    headers: { "Content-Type": "application/json", "X-Master-Key": MASTER_KEY }, 
                    body: JSON.stringify(data) 
                });
                updateSyncStatus('success');
                renderAll();
            } catch(e) { updateSyncStatus('fail'); alert("Save Failed!"); }
        }

        // --- RENDERERS ---
        function renderAll() {
            // Admin Visibility
            document.querySelectorAll('.admin-form').forEach(f => {
                if(f.parentElement.id !== 'attendance') f.style.display = isAdmin ? 'block' : 'none';
            });
            document.querySelectorAll('.delete-btn').forEach(b => b.style.display = isAdmin ? 'inline-block' : 'none');
            document.querySelectorAll('.action-col').forEach(e => e.style.display = isAdmin ? 'table-cell' : 'none');

            // Routine
            const rBody = document.getElementById('routine-body'); rBody.innerHTML='';
            data.routine.forEach((i,x) => {
                rBody.innerHTML += `<tr><td><b>${i.day}</b></td><td>${i.sub}</td><td>${i.room}</td><td class="action-col"><button class="delete-btn" style="color:red;border:none;background:none;cursor:pointer;" onclick="del('routine',${x})">üóëÔ∏è</button></td></tr>`;
            });

            // Students
            const stuL = document.getElementById('student-list'); stuL.innerHTML='';
            data.student.forEach((s,x) => {
                let img = s.img || 'https://cdn-icons-png.flaticon.com/512/3135/3135715.png';
                let btns = isAdmin ? `<button onclick="del('student',${x})" style="background:#ef4444; color:white; border:none; padding:5px 10px; border-radius:4px; float:right;">Delete</button>` : '';
                stuL.innerHTML += `<div class="card" style="display:flex; align-items:center; gap:15px;">
                    <img src="${img}" style="width:50px; height:50px; border-radius:50%; object-fit:cover; border:2px solid var(--active-bg);">
                    <div style="flex:1;">
                        <h4 style="margin:0;">${s.name}</h4>
                        <small style="color:#64748b;">ID: ${s.id} | Dip: ${s.dip||'-'} | ${s.phone}</small>
                    </div>
                    ${btns}
                </div>`;
            });

            // Teachers
            const tL = document.getElementById('teacher-list'); tL.innerHTML='';
            data.teacher.forEach((t,x) => {
                let img = t.img || 'https://cdn-icons-png.flaticon.com/512/1995/1995539.png';
                tL.innerHTML += `<div class="card" style="display:flex; align-items:center; gap:15px;">
                    <img src="${img}" style="width:50px; height:50px; border-radius:50%; object-fit:cover; border:2px solid #334155;">
                    <div style="flex:1;">
                        <b>${t.name}</b><br><small>${t.post}</small>
                    </div>
                    ${isAdmin ? `<button onclick="del('teacher',${x})" style="float:right;color:red;background:none;border:none;">Del</button>`:''}
                </div>`;
            });

            // Notices
            const nList = document.getElementById('notice-list'); nList.innerHTML = '';
            data.notice.slice().reverse().forEach((n, x) => {
                nList.innerHTML += `<div class="card" style="border-left: 4px solid #3b82f6;">
                    <b>${n.title}</b> <span style="font-size:0.75rem; float:right; color:#888;">${n.date}</span>
                    <p style="margin:5px 0 0; font-size:0.9rem; color:#475569;">${n.desc}</p>
                    ${isAdmin ? `<button onclick="del('notice',${data.notice.length-1-x})" style="color:red; background:none; border:none; cursor:pointer; margin-top:5px;">Delete</button>` : ''}
                </div>`;
            });

            // Feed
            const feed = document.getElementById('activity-feed'); feed.innerHTML='';
            if(data.notice.length) {
                feed.innerHTML += `<div style="background:#dbeafe; padding:15px; border-radius:8px; border:1px solid #93c5fd; color:#1e40af; margin-bottom:15px;">
                    üì¢ <b>Latest:</b> ${data.notice[data.notice.length-1].title}
                </div>`;
            }

            // Attendance History
            const attH = document.getElementById('attendance-history'); attH.innerHTML='';
            data.attendance.slice().reverse().forEach((a,i) => {
                let ri = data.attendance.length - 1 - i;
                attH.innerHTML += `<div class="card" style="padding:15px; border-left:4px solid var(--active-bg);">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <b>${a.subject}</b> <small>(${a.date})</small><br>
                            <small>Present: ${a.presentIDs.length} / ${data.student.length}</small>
                        </div>
                        <div>
                            <button onclick="generatePDF(${ri})" style="background:#334155; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;">PDF</button>
                            ${isAdmin ? `<button onclick="del('attendance',${ri})" style="color:red; background:none; border:none; cursor:pointer;">üóëÔ∏è</button>` : ''}
                        </div>
                    </div>
                </div>`;
            });

            // Att Grid
            const grid = document.getElementById('attendance-grid');
            if(grid.innerHTML === '') {
                data.student.forEach(s => {
                    grid.innerHTML += `<div id="att-stu-${s.id}" class="att-student" onclick="toggleAttStatus('${s.id}')">${s.name}<br><small>${s.id}</small></div>`;
                });
            }

            // Others
            const rL=document.getElementById('resource-list'); rL.innerHTML=''; data.resources.forEach((r,x)=>rL.innerHTML+=`<div class="card"><a href="${r.url}" target="_blank" style="text-decoration:none; color:#2563eb; font-weight:bold;">üìÑ ${r.title}</a> ${isAdmin?`<button onclick="del('resources',${x})" style="float:right;color:red;background:none;border:none;">Del</button>`:''}</div>`);
            const cList = document.getElementById('course-list'); cList.innerHTML = ''; data.subjects.forEach((s,x)=>cList.innerHTML+=`<div class="card"><b>${s.name}</b> (${s.code}) <a href="${s.link}" target="_blank">Link</a></div>`);
            const pList = document.getElementById('poll-list'); pList.innerHTML = ''; data.polls.forEach(p=>pList.innerHTML+=`<div class="card"><b>${p.question}</b></div>`);
        }

        // --- ACTIONS ---
        function toggleAttStatus(id) {
            const el = document.getElementById('att-stu-'+id);
            if(tempAttendance.has(id)) { tempAttendance.delete(id); el.classList.remove('present'); }
            else { tempAttendance.add(id); el.classList.add('present'); }
        }
        function selectAllAtt(state) {
            data.student.forEach(s => {
                const el = document.getElementById('att-stu-'+s.id);
                if(state) { tempAttendance.add(s.id); el.classList.add('present'); }
                else { tempAttendance.delete(s.id); el.classList.remove('present'); }
            });
        }
        function saveAttendance() {
            const d = document.getElementById('att-date').value;
            const s = document.getElementById('att-subject').value;
            if(!d || !s) return alert("Date & Subject Needed!");
            data.attendance.push({ date: d, subject: s, presentIDs: Array.from(tempAttendance) });
            tempAttendance.clear();
            document.querySelectorAll('.att-student').forEach(e => e.classList.remove('present'));
            saveData();
        }

        // Submit Student (With Compression)
        function handleStudentSubmit() {
            const n=document.getElementById('s-name').value, i=document.getElementById('s-id').value, d=document.getElementById('s-dip').value, p=document.getElementById('s-phone').value, f=document.getElementById('s-img-file').files[0];
            if(!n) return alert("Name?");
            const saveS = (img) => { 
                data.student.push({name:n, id:i, dip:d, phone:p, img:img}); 
                resetStudentForm(); saveData(); 
            };
            if(f) compressImage(f, (url) => saveS(url)); else saveS('');
        }
        function resetStudentForm() { document.querySelectorAll('#student-form input').forEach(i=>i.value=''); }

        // Submit Teacher (With Compression)
        function handleTeacherSubmit() {
            const n=document.getElementById('t-name').value, post=document.getElementById('t-post').value, ph=document.getElementById('t-phone').value, f=document.getElementById('t-img-file').files[0];
            if(!n) return alert("Name?");
            const saveT = (img) => { 
                data.teacher.push({name:n, post:post, phone:ph, img:img}); 
                document.querySelectorAll('#teacher-form input').forEach(i=>i.value=''); saveData(); 
            };
            if(f) compressImage(f, (url) => saveT(url)); else saveT('');
        }

        // Helpers
        function addRoutine(){ data.routine.push({day:document.getElementById('r-day').value, sub:document.getElementById('r-sub').value, room:document.getElementById('r-room').value}); saveData(); }
        function addSubject(){ data.subjects.push({name:document.getElementById('sub-name').value, code:document.getElementById('sub-code').value, link:document.getElementById('sub-link').value}); saveData(); }
        function addResource(){ data.resources.push({title:document.getElementById('res-title').value, url:document.getElementById('res-url').value}); saveData(); }
        function addNotice(){ data.notice.push({date:document.getElementById('n-date').value, title:document.getElementById('n-title').value, desc:document.getElementById('n-desc').value}); saveData(); }
        function addPoll(){ data.polls.push({question:document.getElementById('poll-quest').value, options:document.getElementById('poll-opts').value.split(',')}); saveData(); }
        function del(key, idx) { if(confirm("Delete?")) { data[key].splice(idx,1); saveData(); } }
        
        function generatePDF(i) {
            const r = data.attendance[i];
            const d = document.createElement('div');
            d.innerHTML = `<h2>Attendance: ${r.subject}</h2><p>Date: ${r.date}</p><hr><ul>${data.student.map(s => `<li style="color:${r.presentIDs.includes(s.id)?'green':'red'}">${s.name} (${s.id}) - ${r.presentIDs.includes(s.id)?'P':'A'}</li>`).join('')}</ul>`;
            html2pdf().from(d).save(`Att_${r.subject}.pdf`);
        }

        // --- UI HELPERS ---
        function showSection(id) {
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active-section'));
            document.getElementById(id).classList.add('active-section');
            document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
            document.getElementById('btn-'+id).classList.add('active');
            if(window.innerWidth < 768) toggleSidebar();
        }
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
            document.querySelector('.overlay').classList.toggle('active');
        }
        function toggleAdminMode() {
            isAdmin = !isAdmin;
            const btn = document.getElementById('admin-btn');
            const span = btn.querySelector('span');
            if(isAdmin) {
                btn.classList.add('active-mode'); span.innerText = "ADMIN ACTIVE";
                document.getElementById('att-controls').style.display = 'block';
            } else {
                btn.classList.remove('active-mode'); span.innerText = "Enable Admin";
                document.getElementById('att-controls').style.display = 'none';
            }
            renderAll();
        }
        function updateSyncStatus(status) {
            const dot = document.getElementById('sync-dot');
            const txt = document.getElementById('sync-text');
            if(status === 'success') {
                dot.classList.add('online'); txt.innerText = "SYNC ACTIVE"; txt.style.color = "#22c55e";
            } else {
                dot.classList.remove('online'); txt.innerText = "SYNC FAILED"; txt.style.color = "#ef4444";
            }
        }

        // --- PROFESSOR X AI LOGIC (ADVANCED) ---
        const modal = document.getElementById('ai-modal');
        const msgBox = document.getElementById('ai-messages');
        const placeholder = document.getElementById('ai-placeholder');
        const waveBox = document.getElementById('wave-box');
        const inputField = document.getElementById('ai-input');
        
        const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        const synth = window.speechSynthesis;
        let isSpeaking = false;

        // Setup
        recognition.lang = 'bn-BD'; 
        recognition.continuous = false;

        function openAI() {
            modal.style.display = 'flex';
            setTimeout(() => {
                const greeting = "‡¶Ü‡¶Æ‡¶ø ‡¶™‡ßç‡¶∞‡¶´‡ßá‡¶∏‡¶∞ ‡¶è‡¶ï‡ßç‡¶∏, ‡¶Ü‡¶™‡¶®‡¶æ‡¶ï‡ßá ‡¶ï‡¶ø‡¶≠‡¶æ‡¶¨‡ßá ‡¶∏‡¶æ‡¶π‡¶æ‡¶Ø‡ßç‡¶Ø ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶ø?";
                addMsg("AI", greeting);
                speak(greeting);
            }, 500);
        }

        function closeAI() {
            modal.style.display = 'none';
            synth.cancel();
            recognition.stop();
            waveBox.style.opacity = '0';
        }

        function sendText() {
            const txt = inputField.value.trim();
            if(!txt) return;
            inputField.value = '';
            placeholder.style.display = 'none';
            addMsg("You", txt);
            processAI(txt);
        }

        function startListening() {
            try {
                recognition.start();
                waveBox.style.opacity = '1';
                inputField.placeholder = "Listening...";
            } catch(e) {}
        }

        recognition.onresult = (event) => {
            const txt = event.results[0][0].transcript;
            placeholder.style.display = 'none';
            addMsg("You", txt);
            processAI(txt);
            inputField.placeholder = "Message Professor X...";
        };

        recognition.onend = () => { if(!isSpeaking) waveBox.style.opacity = '0'; };

        async function processAI(prompt) {
            waveBox.style.opacity = '1';
            
            // Context Aware Prompt
            const sys = `You are 'Professor X', AI assistant for EEE Dept Uttara University.
            Creator: Ibrahim.
            Language: Bangla (mixed with English technical terms).
            Context Data: ${JSON.stringify(data)}
            Keep answers short (max 2-3 sentences).`;
            
            const body = { contents: [{ parts: [{ text: sys + "\nUser: " + prompt }] }] };

            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
                    method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(body)
                });
                const json = await res.json();
                const reply = json.candidates[0].content.parts[0].text;
                addMsg("AI", reply);
                speak(reply);
            } catch(e) {
                addMsg("AI", "‡¶¶‡ßÅ‡¶É‡¶ñ‡¶ø‡¶§, ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶æ‡¶∞‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá‡•§");
                waveBox.style.opacity = '0';
            }
        }

        function speak(text) {
            synth.cancel();
            isSpeaking = true;
            waveBox.style.opacity = '1';
            
            const u = new SpeechSynthesisUtterance(text);
            const v = synth.getVoices().find(v => v.lang.includes('bn') || v.lang.includes('Bengali'));
            if(v) u.voice = v;
            
            u.onend = () => { isSpeaking = false; waveBox.style.opacity = '0'; };
            synth.speak(u);
        }

        function addMsg(sender, text) {
            const div = document.createElement('div');
            const isAI = sender === "AI";
            div.style.alignSelf = isAI ? "flex-start" : "flex-end";
            div.style.background = isAI ? "#334155" : "#f59e0b";
            div.style.color = isAI ? "white" : "black";
            div.style.padding = "10px 15px";
            div.style.borderRadius = "12px";
            div.style.maxWidth = "80%";
            div.style.fontSize = "0.9rem";
            div.style.boxShadow = "0 2px 5px rgba(0,0,0,0.1)";
            div.style.lineHeight = "1.4";
            div.innerHTML = `<strong>${isAI ? 'üë®‚Äçüè´' : 'üë§'}</strong> ${text}`;
            msgBox.appendChild(div);
            msgBox.scrollTop = msgBox.scrollHeight;
        }

        // INIT
        fetchData();
    </script>
</body>
</html>
