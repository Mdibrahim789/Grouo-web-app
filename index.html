<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UU EEE Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        /* --- THEME VARS --- */
        :root {
            --sidebar-bg: #0f172a;      /* Dark Blue/Black */
            --sidebar-hover: #1e293b;
            --active-bg: #f59e0b;       /* Amber/Orange */
            --active-text: #000000;
            --text-muted: #94a3b8;
            --text-light: #ffffff;
            --bg-body: #f1f5f9;         /* Light Grey Background */
            --card-bg: #ffffff;
            --success: #22c55e;
            --danger: #ef4444;
        }

        * { box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; margin: 0; padding: 0; background: var(--bg-body); color: #333; height: 100vh; overflow: hidden; display: flex; }

        /* --- SIDEBAR --- */
        .sidebar {
            width: 260px;
            background: var(--sidebar-bg);
            color: white;
            display: flex;
            flex-direction: column;
            padding: 20px;
            transition: transform 0.3s ease;
            z-index: 1000;
            flex-shrink: 0;
        }

        /* Logo Area */
        .brand {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.5rem;
            font-weight: 800;
            margin-bottom: 30px;
            color: var(--text-light);
        }
        .brand i { color: var(--active-bg); }

        /* Navigation Links */
        .nav-links { flex: 1; list-style: none; padding: 0; margin: 0; overflow-y: auto; }
        .nav-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            margin-bottom: 8px;
            border-radius: 8px;
            color: var(--text-muted);
            cursor: pointer;
            transition: 0.2s;
            font-weight: 600;
            font-size: 0.95rem;
        }
        .nav-item i { width: 25px; font-size: 1.1rem; }
        .nav-item:hover { background: var(--sidebar-hover); color: var(--text-light); }
        
        /* Active State (Orange) */
        .nav-item.active {
            background: var(--active-bg);
            color: var(--active-text);
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
        }

        /* Sidebar Footer (Admin & Sync) */
        .sidebar-footer { margin-top: auto; padding-top: 20px; border-top: 1px solid #334155; }
        
        .admin-box {
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            border: 1px solid transparent;
            transition: 0.3s;
        }
        .admin-box.active-mode {
            background: rgba(245, 158, 11, 0.1);
            border-color: var(--active-bg);
            color: var(--active-bg);
        }
        
        .sync-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 15px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--danger); }
        .status-dot.online { background: var(--success); }

        /* --- MAIN CONTENT --- */
        .main-content {
            flex: 1;
            height: 100vh;
            overflow-y: auto;
            position: relative;
            background: var(--bg-body);
        }

        /* Header for Mobile */
        .mobile-header {
            display: none;
            background: var(--sidebar-bg);
            color: white;
            padding: 15px;
            align-items: center;
            /* Changed to align items to left */
            justify-content: flex-start; 
            gap: 20px;
            position: sticky;
            top: 0;
            z-index: 99;
        }

        .content-area {
            padding: 30px;
            max-width: 1000px;
            margin: 0 auto;
        }

        /* Section Styling */
        .section-title { font-size: 1.5rem; color: #1e293b; margin-bottom: 20px; border-bottom: 2px solid #e2e8f0; padding-bottom: 10px; }
        .content-section { display: none; animation: fadeUp 0.3s ease; }
        .content-section.active-section { display: block; }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Cards */
        .card { background: var(--card-bg); padding: 20px; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; }
        
        /* Admin Forms */
        .admin-form { display: none; background: #fff; padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #cbd5e1; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .admin-form input, .admin-form select, .admin-form textarea { width: 100%; padding: 10px; margin: 8px 0; border: 1px solid #cbd5e1; border-radius: 6px; }
        .admin-form button { background: var(--active-bg); color: black; font-weight: bold; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; }

        /* Tables & Lists */
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; }
        th { background: #f8fafc; text-align: left; padding: 12px; font-size: 0.85rem; color: #64748b; text-transform: uppercase; }
        td { padding: 12px; border-bottom: 1px solid #f1f5f9; }
        
        /* Grid for Attendance */
        .att-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; }
        .att-student { background: white; border: 1px solid #e2e8f0; padding: 15px; border-radius: 8px; text-align: center; cursor: pointer; transition: 0.2s; }
        .att-student.present { background: #dcfce7; border-color: #22c55e; color: #166534; font-weight: bold; }

        /* --- RESPONSIVE --- */
        @media (max-width: 768px) {
            body { flex-direction: column; }
            .sidebar { 
                position: fixed; top: 0; left: 0; height: 100%; transform: translateX(-100%); 
                width: 280px; box-shadow: 5px 0 15px rgba(0,0,0,0.3);
            }
            .sidebar.open { transform: translateX(0); }
            .mobile-header { display: flex; }
            .content-area { padding: 15px; padding-bottom: 80px; }
            .overlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:999;}
            .overlay.active { display: block; }
        }
    </style>
</head>
<body>

    <div class="overlay" onclick="toggleSidebar()"></div>

    <nav class="sidebar" id="sidebar">
        <div class="brand">
            <i class="fa-solid fa-bolt"></i> UU EEE
        </div>

        <ul class="nav-links">
            <li class="nav-item active" onclick="showSection('home')" id="btn-home">
                <i class="fa-solid fa-house"></i> Dashboard
            </li>
            <li class="nav-item" onclick="showSection('academic')" id="btn-academic">
                <i class="fa-solid fa-book-open"></i> Academic
            </li>
            <li class="nav-item" onclick="showSection('students')" id="btn-students">
                <i class="fa-solid fa-users"></i> Students
            </li>
            <li class="nav-item" onclick="showSection('teachers')" id="btn-teachers">
                <i class="fa-solid fa-chalkboard-user"></i> Faculty
            </li>
            <li class="nav-item" onclick="showSection('notice')" id="btn-notice">
                <i class="fa-solid fa-bullhorn"></i> Notices
            </li>
            <li class="nav-item" onclick="showSection('attendance')" id="btn-attendance">
                <i class="fa-solid fa-clipboard-check"></i> Attendance
            </li>
            <li class="nav-item" onclick="showSection('polls')" id="btn-polls">
                <i class="fa-solid fa-square-poll-vertical"></i> Polls
            </li>
        </ul>

        <div class="sidebar-footer">
            <div class="admin-box" id="admin-btn" onclick="toggleAdminMode()">
                <i class="fa-solid fa-lock"></i> <span>Enable Admin</span>
            </div>
            <div class="sync-status">
                <div class="status-dot" id="sync-dot"></div>
                <span id="sync-text">Connecting...</span>
            </div>
        </div>
    </nav>

    <div class="main-content">
        <div class="mobile-header">
            <i class="fa-solid fa-bars" style="font-size:1.5rem; cursor:pointer;" onclick="toggleSidebar()"></i>
            
            <div style="font-weight:bold; display:flex; gap:10px; align-items:center;">
                <i class="fa-solid fa-bolt" style="color:#f59e0b;"></i> UU EEE
            </div>
        </div>

        <div class="content-area">
            
            <div id="home" class="content-section active-section">
                <h2 class="section-title">üëã Welcome Batch 2026</h2>
                <div id="activity-feed"></div>

                <h3 style="margin-top:30px;">üìÖ Class Routine</h3>
                <div class="admin-form">
                    <input type="text" id="r-day" placeholder="Day (e.g. Sunday)">
                    <input type="text" id="r-sub" placeholder="Subject">
                    <input type="text" id="r-room" placeholder="Room">
                    <button onclick="addRoutine()">‚ûï Add Class</button>
                </div>
                <table id="routine-table"><thead><tr><th>Day</th><th>Subject</th><th>Room</th><th class="action-col">Act</th></tr></thead><tbody id="routine-body"></tbody></table>
            </div>

            <div id="academic" class="content-section">
                <h2 class="section-title">üìò Academic Resources</h2>
                <div class="admin-form">
                    <h3>Add Course</h3>
                    <input type="text" id="sub-name" placeholder="Name">
                    <input type="text" id="sub-code" placeholder="Code">
                    <input type="text" id="sub-link" placeholder="Syllabus Link">
                    <button onclick="addSubject()">Add Course</button>
                </div>
                <div id="course-list"></div>
                <h3 style="margin-top:30px">üìö Files & Links</h3>
                <div class="admin-form">
                    <input type="text" id="res-title" placeholder="Title">
                    <input type="text" id="res-url" placeholder="URL">
                    <button onclick="addResource()">Add Resource</button>
                </div>
                <div id="resource-list"></div>
            </div>

            <div id="students" class="content-section">
                <h2 class="section-title">üë• Student Profiles</h2>
                <div class="admin-form" id="student-form">
                    <input type="file" id="s-img-file" accept="image/*">
                    <input type="text" id="s-name" placeholder="Name">
                    <input type="text" id="s-id" placeholder="ID">
                    <input type="text" id="s-phone" placeholder="Phone">
                    <button id="btn-student-action" onclick="handleStudentSubmit()">Add Student</button>
                    <button onclick="resetStudentForm()" style="background:#64748b; color:white; margin-top:5px;">Cancel</button>
                </div>
                <div id="student-list"></div>
            </div>

            <div id="teachers" class="content-section">
                <h2 class="section-title">üë®‚Äçüè´ Faculty Members</h2>
                <div class="admin-form">
                    <input type="text" id="t-name" placeholder="Name">
                    <input type="text" id="t-post" placeholder="Designation">
                    <input type="text" id="t-phone" placeholder="Phone">
                    <button onclick="addTeacher()">Add Faculty</button>
                </div>
                <div id="teacher-list"></div>
            </div>

            <div id="notice" class="content-section">
                <h2 class="section-title">üîî Notice Board</h2>
                <div class="admin-form">
                    <input type="date" id="n-date">
                    <input type="text" id="n-title" placeholder="Title">
                    <textarea id="n-desc" placeholder="Details"></textarea>
                    <button onclick="addNotice()">Post Notice</button>
                </div>
                <div id="notice-list"></div>
            </div>

            <div id="attendance" class="content-section">
                <h2 class="section-title">üìù Take Attendance</h2>
                <div class="admin-form" style="display:block !important;"> <div id="att-controls" style="display:none;"> <input type="date" id="att-date">
                        <input type="text" id="att-subject" placeholder="Subject Name">
                        <div style="display:flex; gap:10px; margin:10px 0;">
                            <button onclick="selectAllAtt(true)" style="background:#334155; color:white; font-size:0.8rem;">All Present</button>
                            <button onclick="selectAllAtt(false)" style="background:#334155; color:white; font-size:0.8rem;">Clear</button>
                        </div>
                        <div id="attendance-grid" class="att-grid"></div>
                        <button onclick="saveAttendance()" style="margin-top:15px; width:100%;">üíæ Save Record</button>
                        <hr>
                    </div>
                    <h3>üìú History</h3>
                    <div id="attendance-history"></div>
                </div>
            </div>

             <div id="polls" class="content-section">
                <h2 class="section-title">üó≥Ô∏è Voting & Polls</h2>
                <div class="admin-form">
                    <input type="text" id="poll-quest" placeholder="Question">
                    <textarea id="poll-opts" placeholder="Options (comma separated)"></textarea>
                    <button onclick="addPoll()">Create Poll</button>
                </div>
                <div id="poll-list"></div>
            </div>

        </div>
    </div>

    <script>
        // CONFIG - UPDATED
        const BIN_ID = "696df6b5ae596e708fe62a8b"; 
        const MASTER_KEY = "$2a$10$e0AwKK3h1YV3/kmqFxYITOPhqzvyD6OoCaTUZ6PzcRBfWJwpQInOW";

        // STATE
        let data = { routine:[], student:[], teacher:[], notice:[], attendance:[], polls:[], resources:[], subjects:[], marks:{} };
        let isAdmin = false;
        let tempAttendance = new Set();
        let editStudentIndex = -1;

        // UI HELPERS
        function showSection(id) {
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active-section'));
            document.getElementById(id).classList.add('active-section');
            document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
            document.getElementById('btn-'+id).classList.add('active');
            
            // Mobile Sidebar Close
            if(window.innerWidth < 768) toggleSidebar();
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
            document.querySelector('.overlay').classList.toggle('active');
        }

        function toggleAdminMode() {
            isAdmin = !isAdmin;
            const btn = document.getElementById('admin-btn');
            const span = btn.querySelector('span');
            
            if(isAdmin) {
                btn.classList.add('active-mode');
                span.innerText = "ADMIN ACTIVE";
                document.getElementById('att-controls').style.display = 'block';
            } else {
                btn.classList.remove('active-mode');
                span.innerText = "Enable Admin";
                document.getElementById('att-controls').style.display = 'none';
            }
            renderAll();
        }

        function updateSyncStatus(status) {
            const dot = document.getElementById('sync-dot');
            const txt = document.getElementById('sync-text');
            if(status === 'success') {
                dot.classList.add('online');
                txt.innerText = "SYNC ACTIVE";
                txt.style.color = "#22c55e";
            } else {
                dot.classList.remove('online');
                txt.innerText = "SYNC FAILED";
                txt.style.color = "#ef4444";
            }
        }

        // DATA HANDLERS
        async function fetchData() {
            updateSyncStatus('loading');
            try {
                let res = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, { headers: { "X-Master-Key": MASTER_KEY } });
                if(!res.ok) throw new Error("API Error");
                let json = await res.json();
                
                // Merge defaults to prevent crashes
                let d = json.record;
                data.routine = d.routine || [];
                data.student = d.student || [];
                data.teacher = d.teacher || [];
                data.notice = d.notice || [];
                data.attendance = d.attendance || [];
                data.polls = d.polls || [];
                data.resources = d.resources || [];
                data.subjects = d.subjects || [];
                data.marks = d.marks || {};
                
                renderAll();
                updateSyncStatus('success');
            } catch(e) { 
                console.error(e);
                updateSyncStatus('fail');
            }
        }

        async function saveData() {
            updateSyncStatus('loading');
            try {
                await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, { 
                    method: "PUT", 
                    headers: { "Content-Type": "application/json", "X-Master-Key": MASTER_KEY }, 
                    body: JSON.stringify(data) 
                });
                updateSyncStatus('success');
                renderAll();
            } catch(e) { updateSyncStatus('fail'); alert("Save Failed!"); }
        }

        // RENDERERS
        function renderAll() {
            // Visibility Check
            document.querySelectorAll('.admin-form').forEach(f => {
                if(f.parentElement.id !== 'attendance') f.style.display = isAdmin ? 'block' : 'none';
            });
            document.querySelectorAll('.delete-btn').forEach(b => b.style.display = isAdmin ? 'inline-block' : 'none');

            // --- ROUTINE ---
            const rBody = document.getElementById('routine-body'); rBody.innerHTML='';
            data.routine.forEach((i,x) => {
                rBody.innerHTML += `<tr><td><b>${i.day}</b></td><td>${i.sub}</td><td>${i.room}</td><td class="action-col"><button class="delete-btn" style="color:red;border:none;background:none;cursor:pointer;" onclick="del('routine',${x})">üóëÔ∏è</button></td></tr>`;
            });

            // --- STUDENTS ---
            const stuL = document.getElementById('student-list'); stuL.innerHTML='';
            data.student.forEach((s,x) => {
                let img = s.img || 'https://cdn-icons-png.flaticon.com/512/3135/3135715.png';
                let btns = isAdmin ? `<button onclick="del('student',${x})" style="background:#ef4444; color:white; border:none; padding:5px 10px; border-radius:4px; float:right;">Delete</button>` : '';
                stuL.innerHTML += `<div class="card" style="display:flex; align-items:center; gap:15px;">
                    <img src="${img}" style="width:50px; height:50px; border-radius:50%; object-fit:cover; border:2px solid var(--active-bg);">
                    <div style="flex:1;">
                        <h4 style="margin:0;">${s.name}</h4>
                        <small style="color:#64748b;">ID: ${s.id} | ${s.phone}</small>
                    </div>
                    ${btns}
                </div>`;
            });

            // --- ATTENDANCE GRID ---
            const grid = document.getElementById('attendance-grid');
            if(grid.innerHTML === '') {
                data.student.forEach(s => {
                    grid.innerHTML += `<div id="att-stu-${s.id}" class="att-student" onclick="toggleAttStatus('${s.id}')">${s.name}<br><small>${s.id}</small></div>`;
                });
            }

            // --- ATTENDANCE HISTORY ---
            const attH = document.getElementById('attendance-history'); attH.innerHTML='';
            data.attendance.slice().reverse().forEach((a,i) => {
                let ri = data.attendance.length - 1 - i;
                attH.innerHTML += `<div class="card" style="padding:15px; border-left:4px solid var(--active-bg);">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <b>${a.subject}</b> <small>(${a.date})</small><br>
                            <small>Present: ${a.presentIDs.length} / ${data.student.length}</small>
                        </div>
                        <div>
                            <button onclick="generatePDF(${ri})" style="background:#334155; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;">PDF</button>
                            ${isAdmin ? `<button onclick="del('attendance',${ri})" style="color:red; background:none; border:none; cursor:pointer;">üóëÔ∏è</button>` : ''}
                        </div>
                    </div>
                </div>`;
            });
            
            // --- NOTICES ---
            const nList = document.getElementById('notice-list'); nList.innerHTML = '';
            data.notice.slice().reverse().forEach((n, x) => {
                nList.innerHTML += `<div class="card" style="border-left: 4px solid #3b82f6;">
                    <b>${n.title}</b> <span style="font-size:0.75rem; float:right; color:#888;">${n.date}</span>
                    <p style="margin:5px 0 0; font-size:0.9rem; color:#475569;">${n.desc}</p>
                    ${isAdmin ? `<button onclick="del('notice',${data.notice.length-1-x})" style="color:red; background:none; border:none; cursor:pointer; margin-top:5px;">Delete</button>` : ''}
                </div>`;
            });
            
            // --- DASHBOARD FEED ---
            const feed = document.getElementById('activity-feed'); feed.innerHTML='';
            if(data.notice.length) {
                feed.innerHTML += `<div style="background:#dbeafe; padding:15px; border-radius:8px; border:1px solid #93c5fd; color:#1e40af; margin-bottom:15px;">
                    üì¢ <b>Latest:</b> ${data.notice[data.notice.length-1].title}
                </div>`;
            }

            // Render others (Teachers, Resources, Polls) - Minimal version
            const tL=document.getElementById('teacher-list'); tL.innerHTML=''; data.teacher.forEach((t,x)=>tL.innerHTML+=`<div class="card"><b>${t.name}</b><br><small>${t.post}</small>${isAdmin?`<button onclick="del('teacher',${x})" style="float:right;color:red;background:none;border:none;">Del</button>`:''}</div>`);
            
            const rL=document.getElementById('resource-list'); rL.innerHTML=''; data.resources.forEach((r,x)=>rL.innerHTML+=`<div class="card"><a href="${r.url}" target="_blank" style="text-decoration:none; color:#2563eb; font-weight:bold;">üìÑ ${r.title}</a> ${isAdmin?`<button onclick="del('resources',${x})" style="float:right;color:red;background:none;border:none;">Del</button>`:''}</div>`);
        }

        // LOGIC
        function toggleAttStatus(id) {
            const el = document.getElementById('att-stu-'+id);
            if(tempAttendance.has(id)) { tempAttendance.delete(id); el.classList.remove('present'); }
            else { tempAttendance.add(id); el.classList.add('present'); }
        }
        function selectAllAtt(state) {
            data.student.forEach(s => {
                const el = document.getElementById('att-stu-'+s.id);
                if(state) { tempAttendance.add(s.id); el.classList.add('present'); }
                else { tempAttendance.delete(s.id); el.classList.remove('present'); }
            });
        }
        function saveAttendance() {
            const d = document.getElementById('att-date').value;
            const s = document.getElementById('att-subject').value;
            if(!d || !s) return alert("Date & Subject Needed!");
            data.attendance.push({ date: d, subject: s, presentIDs: Array.from(tempAttendance) });
            tempAttendance.clear();
            document.querySelectorAll('.att-student').forEach(e => e.classList.remove('present'));
            saveData();
        }
        function addRoutine(){ data.routine.push({day:document.getElementById('r-day').value, sub:document.getElementById('r-sub').value, room:document.getElementById('r-room').value}); saveData(); }
        function addSubject(){ data.subjects.push({name:document.getElementById('sub-name').value, code:document.getElementById('sub-code').value, link:document.getElementById('sub-link').value}); saveData(); }
        function addResource(){ data.resources.push({title:document.getElementById('res-title').value, url:document.getElementById('res-url').value}); saveData(); }
        function addTeacher(){ data.teacher.push({name:document.getElementById('t-name').value, post:document.getElementById('t-post').value, phone:document.getElementById('t-phone').value}); saveData(); }
        function addNotice(){ data.notice.push({date:document.getElementById('n-date').value, title:document.getElementById('n-title').value, desc:document.getElementById('n-desc').value}); saveData(); }
        
        function handleStudentSubmit() {
            const n=document.getElementById('s-name').value, i=document.getElementById('s-id').value, p=document.getElementById('s-phone').value, f=document.getElementById('s-img-file').files[0];
            if(!n) return alert("Name?");
            const saveS = (img) => { data.student.push({name:n,id:i,phone:p,img:img}); document.getElementById('s-name').value=''; saveData(); };
            if(f){const r=new FileReader(); r.onload=(e)=>saveS(e.target.result); r.readAsDataURL(f);} else saveS('');
        }
        
        function del(key, idx) { if(confirm("Delete?")) { data[key].splice(idx,1); saveData(); } }

        function generatePDF(i) {
            const r = data.attendance[i];
            const d = document.createElement('div');
            d.innerHTML = `<h2>Attendance: ${r.subject}</h2><p>Date: ${r.date}</p><hr><ul>${data.student.map(s => `<li style="color:${r.presentIDs.includes(s.id)?'green':'red'}">${s.name} (${s.id}) - ${r.presentIDs.includes(s.id)?'P':'A'}</li>`).join('')}</ul>`;
            html2pdf().from(d).save(`Att_${r.subject}.pdf`);
        }

        // INIT
        fetchData();
    </script>
</body>
</html>
