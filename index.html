<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UU EEE Dashboard</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        /* --- THEME VARIABLES --- */
        :root {
            --sidebar-bg: #0f172a;
            --sidebar-hover: #1e293b;
            --active-bg: #f59e0b;       
            --active-text: #000000;
            --text-muted: #94a3b8;
            --text-light: #ffffff;
            --bg-body: #f1f5f9;
            --card-bg: #ffffff;
            --success: #22c55e;
            --danger: #ef4444;
        }

        * { box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; margin: 0; padding: 0; background: var(--bg-body); color: #333; height: 100vh; overflow: hidden; display: flex; }

        /* --- SIDEBAR UI --- */
        .sidebar { width: 260px; background: var(--sidebar-bg); color: white; display: flex; flex-direction: column; padding: 20px; transition: transform 0.3s ease; z-index: 1000; flex-shrink: 0; }
        .brand { display: flex; align-items: center; gap: 10px; font-size: 1.5rem; font-weight: 800; margin-bottom: 30px; color: var(--text-light); }
        .brand i { color: var(--active-bg); }
        .nav-links { flex: 1; list-style: none; padding: 0; margin: 0; overflow-y: auto; }
        .nav-item { display: flex; align-items: center; padding: 12px 15px; margin-bottom: 8px; border-radius: 8px; color: var(--text-muted); cursor: pointer; transition: 0.2s; font-weight: 600; font-size: 0.95rem; }
        .nav-item:hover { background: var(--sidebar-hover); color: var(--text-light); }
        .nav-item.active { background: var(--active-bg); color: var(--active-text); box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3); }
        .sidebar-footer { margin-top: auto; padding-top: 20px; border-top: 1px solid #334155; }
        
        .admin-box { background: rgba(255,255,255,0.05); border-radius: 8px; padding: 12px; text-align: center; cursor: pointer; border: 1px solid transparent; transition: 0.3s; }
        .admin-box.active-mode { background: rgba(34, 197, 94, 0.1); border-color: var(--success); color: var(--success); }
        .admin-box.cr-mode { background: rgba(245, 158, 11, 0.1); border-color: var(--active-bg); color: var(--active-bg); }

        .sync-status { display: flex; align-items: center; gap: 8px; font-size: 0.75rem; color: var(--text-muted); margin-top: 15px; font-weight: 600; text-transform: uppercase; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--danger); }
        .status-dot.online { background: var(--success); }

        /* --- MAIN CONTENT --- */
        .main-content { flex: 1; height: 100vh; overflow-y: auto; position: relative; background: var(--bg-body); }
        .mobile-header { display: none; background: var(--sidebar-bg); color: white; padding: 15px; align-items: center; justify-content: flex-start; gap: 20px; position: sticky; top: 0; z-index: 99; }
        .content-area { padding: 30px; max-width: 1000px; margin: 0 auto; padding-bottom: 120px; }
        .section-title { font-size: 1.5rem; color: #1e293b; margin-bottom: 20px; border-bottom: 2px solid #e2e8f0; padding-bottom: 10px; }
        .content-section { display: none; animation: fadeUp 0.3s ease; }
        .content-section.active-section { display: block; }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .card { background: var(--card-bg); padding: 20px; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; }
        .admin-form { display: none; background: #fff; padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #cbd5e1; border-left: 5px solid var(--active-bg); }
        .admin-form input, .admin-form select, .admin-form textarea { width: 100%; padding: 10px; margin: 8px 0; border: 1px solid #cbd5e1; border-radius: 6px; }
        .admin-form button { background: var(--active-bg); color: black; font-weight: bold; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; margin-top: 10px; width: 100%; }

        table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; margin-bottom: 20px; }
        th { background: #f8fafc; text-align: left; padding: 12px; font-size: 0.85rem; color: #64748b; text-transform: uppercase; }
        td { padding: 12px; border-bottom: 1px solid #f1f5f9; }

        .routine-header { background: #e2e8f0; padding: 8px 15px; font-weight: bold; border-radius: 8px 8px 0 0; color: #1e293b; display: flex; align-items: center; gap: 8px; margin-top: 20px; }
        .routine-header.off { border-left: 5px solid #22c55e; }
        .routine-header.on { border-left: 5px solid #3b82f6; }

        .att-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; margin-bottom: 15px; }
        .att-student { background: white; border: 1px solid #e2e8f0; padding: 15px; border-radius: 8px; text-align: center; cursor: pointer; transition: 0.2s; }
        .att-student.present { background: #dcfce7; border-color: #22c55e; color: #166534; font-weight: bold; }

        /* --- CR MANAGEMENT UI --- */
        .cr-panel { background: #1e293b; color: white; padding: 15px; border-radius: 10px; margin-bottom: 20px; display: none; }
        .permission-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin: 10px 0; }
        .perm-check { display: flex; align-items: center; gap: 5px; font-size: 0.85rem; }
        .cr-list-item { background: rgba(255,255,255,0.1); padding: 8px; margin-top: 5px; border-radius: 5px; display: flex; justify-content: space-between; font-size: 0.85rem; }

        @media (max-width: 768px) {
            body { flex-direction: column; }
            .sidebar { position: fixed; top: 0; left: 0; height: 100%; transform: translateX(-100%); width: 280px; box-shadow: 5px 0 15px rgba(0,0,0,0.3); }
            .sidebar.open { transform: translateX(0); }
            .mobile-header { display: flex; }
            .content-area { padding: 15px; padding-bottom: 120px; }
            .overlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:998;}
            .overlay.active { display: block; }
        }
    </style>
</head>
<body>

    <div class="overlay" onclick="toggleSidebar()"></div>

    <nav class="sidebar" id="sidebar">
        <div class="brand"><i class="fa-solid fa-bolt"></i> UU EEE</div>
        <ul class="nav-links">
            <li class="nav-item active" onclick="showSection('home')" id="btn-home"><i class="fa-solid fa-house"></i> Dashboard</li>
            <li class="nav-item" onclick="showSection('academic')" id="btn-academic"><i class="fa-solid fa-book-open"></i> Academic</li>
            <li class="nav-item" onclick="showSection('students')" id="btn-students"><i class="fa-solid fa-users"></i> Students</li>
            <li class="nav-item" onclick="showSection('teachers')" id="btn-teachers"><i class="fa-solid fa-chalkboard-user"></i> Faculty</li>
            <li class="nav-item" onclick="showSection('notice')" id="btn-notice"><i class="fa-solid fa-bullhorn"></i> Notices</li>
            <li class="nav-item" onclick="showSection('attendance')" id="btn-attendance"><i class="fa-solid fa-clipboard-check"></i> Attendance</li>
            <li class="nav-item" onclick="showSection('polls')" id="btn-polls"><i class="fa-solid fa-square-poll-vertical"></i> Polls</li>
        </ul>
        <div class="sidebar-footer">
            <div class="admin-box" id="admin-btn" onclick="handleLogin()">
                <i class="fa-solid fa-lock"></i> <span id="auth-text">Enable Admin</span>
            </div>
            <div class="sync-status"><div class="status-dot" id="sync-dot"></div><span id="sync-text">Connecting...</span></div>
        </div>
    </nav>

    <div class="main-content">
        <div class="mobile-header">
            <i class="fa-solid fa-bars" style="font-size:1.5rem; cursor:pointer;" onclick="toggleSidebar()"></i>
            <div style="font-weight:bold; display:flex; gap:10px; align-items:center;"><i class="fa-solid fa-bolt" style="color:#f59e0b;"></i> UU EEE</div>
        </div>

        <div class="content-area">
            
            <div id="master-panel" class="cr-panel">
                <h3>üëë Master Admin Panel</h3>
                <p style="font-size:0.8rem; color:#cbd5e1;">Generate Access Keys for CRs</p>
                <div style="background:rgba(0,0,0,0.2); padding:10px; border-radius:8px;">
                    <input type="text" id="new-cr-name" placeholder="CR Name / Note" style="width:100%; padding:5px; margin-bottom:5px; border-radius:4px; border:none;">
                    <div class="permission-grid">
                        <div class="perm-check"><input type="checkbox" id="perm-routine"> Routine</div>
                        <div class="perm-check"><input type="checkbox" id="perm-notice"> Notices</div>
                        <div class="perm-check"><input type="checkbox" id="perm-academic"> Academic</div>
                        <div class="perm-check"><input type="checkbox" id="perm-student"> Students</div>
                        <div class="perm-check"><input type="checkbox" id="perm-teacher"> Teachers</div>
                        <div class="perm-check"><input type="checkbox" id="perm-attendance"> Attendance</div>
                        <div class="perm-check"><input type="checkbox" id="perm-polls"> Polls</div>
                    </div>
                    <button onclick="generateCRKey()" style="background:#22c55e; color:white; border:none; padding:8px; width:100%; border-radius:4px; cursor:pointer;">Generate Key</button>
                </div>
                <div id="cr-keys-list" style="margin-top:10px;"></div>
            </div>

            <div id="home" class="content-section active-section">
                <h2 class="section-title">üëã Welcome Batch 2026</h2>
                <div id="activity-feed"></div>

                <div class="admin-form" data-perm="routine">
                    <h3>Add Class Routine</h3>
                    <select id="r-type" style="margin-bottom:10px;">
                        <option value="Offline">üè¢ Offline Class (Campus)</option>
                        <option value="Online">üíª Online Class</option>
                    </select>
                    <input type="text" id="r-day" placeholder="Day (e.g. Sunday)">
                    <input type="text" id="r-sub" placeholder="Subject">
                    <input type="text" id="r-room" placeholder="Room">
                    <button onclick="addRoutine()">‚ûï Add Class</button>
                </div>

                <div class="routine-header off"><i class="fa-solid fa-building"></i> Offline Class (Campus)</div>
                <div style="overflow-x:auto;">
                    <table id="routine-off-table">
                        <thead><tr><th>Day</th><th>Subject</th><th>Room</th><th class="action-col">Act</th></tr></thead>
                        <tbody id="routine-off-body"></tbody>
                    </table>
                </div>

                <div class="routine-header on"><i class="fa-solid fa-laptop"></i> Online Class</div>
                <div style="overflow-x:auto;">
                    <table id="routine-on-table">
                        <thead><tr><th>Day</th><th>Subject</th><th>Link</th><th class="action-col">Act</th></tr></thead>
                        <tbody id="routine-on-body"></tbody>
                    </table>
                </div>
            </div>

            <div id="academic" class="content-section">
                <h2 class="section-title">üìò Academic Resources</h2>
                <div class="admin-form" data-perm="academic">
                    <h3>Add Course</h3>
                    <input type="text" id="sub-name" placeholder="Name">
                    <input type="text" id="sub-code" placeholder="Code">
                    <input type="text" id="sub-link" placeholder="Syllabus Link">
                    <button onclick="addSubject()">Add Course</button>
                    <hr>
                    <h3>Add Resource</h3>
                    <input type="text" id="res-title" placeholder="Title">
                    <input type="text" id="res-url" placeholder="URL">
                    <button onclick="addResource()">Add Resource</button>
                </div>
                <div id="course-list"></div>
                <h3 style="margin-top:30px">üìö Files & Links</h3>
                <div id="resource-list"></div>
            </div>

            <div id="students" class="content-section">
                <h2 class="section-title">üë• Student Profiles</h2>
                <div class="admin-form" id="student-form" data-perm="student">
                    <label style="font-weight:bold; font-size:0.9rem;">Profile Picture (Auto Compressed)</label>
                    <input type="file" id="s-img-file" accept="image/*">
                    <input type="text" id="s-name" placeholder="Name">
                    <input type="text" id="s-id" placeholder="ID">
                    <input type="text" id="s-dip" placeholder="Diploma Session (e.g. 2021-22)">
                    <input type="text" id="s-phone" placeholder="Phone">
                    <button onclick="handleStudentSubmit()">Add Student</button>
                    <button onclick="resetStudentForm()" style="background:#64748b; margin-top:5px;">Cancel</button>
                </div>
                <div id="student-list"></div>
            </div>

            <div id="teachers" class="content-section">
                <h2 class="section-title">üë®‚Äçüè´ Faculty Members</h2>
                <div class="admin-form" id="teacher-form" data-perm="teacher">
                    <label style="font-weight:bold; font-size:0.9rem;">Profile Picture</label>
                    <input type="file" id="t-img-file" accept="image/*">
                    <input type="text" id="t-name" placeholder="Name">
                    <input type="text" id="t-post" placeholder="Designation">
                    <input type="text" id="t-phone" placeholder="Phone">
                    <button onclick="handleTeacherSubmit()">Add Faculty</button>
                </div>
                <div id="teacher-list"></div>
            </div>

            <div id="notice" class="content-section">
                <h2 class="section-title">üîî Notice Board</h2>
                <div class="admin-form" data-perm="notice">
                    <input type="date" id="n-date">
                    <input type="text" id="n-title" placeholder="Title">
                    <textarea id="n-desc" placeholder="Details"></textarea>
                    <button onclick="addNotice()">Post Notice</button>
                </div>
                <div id="notice-list"></div>
            </div>

            <div id="attendance" class="content-section">
                <h2 class="section-title">üìù Take Attendance</h2>
                <div class="admin-form" data-perm="attendance" style="display:block !important;"> 
                    <div id="att-controls" style="display:none;"> 
                        <input type="date" id="att-date">
                        <input type="text" id="att-subject" placeholder="Subject Name">
                        <div style="display:flex; gap:10px; margin:10px 0;">
                            <button onclick="selectAllAtt(true)" style="background:#334155; color:white; font-size:0.8rem; width:auto;">All Present</button>
                            <button onclick="selectAllAtt(false)" style="background:#334155; color:white; font-size:0.8rem; width:auto;">Clear</button>
                        </div>
                        <div id="attendance-grid" class="att-grid"></div>
                        <button onclick="saveAttendance()">üíæ Save Record</button>
                        <hr>
                    </div>
                    <h3>üìú History</h3>
                    <div id="attendance-history"></div>
                </div>
            </div>

             <div id="polls" class="content-section">
                <h2 class="section-title">üó≥Ô∏è Voting & Polls</h2>
                <div class="admin-form" data-perm="polls">
                    <input type="text" id="poll-quest" placeholder="Question">
                    <textarea id="poll-opts" placeholder="Options (comma separated)"></textarea>
                    <button onclick="addPoll()">Create Poll</button>
                </div>
                <div id="poll-list"></div>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIG ---
        const BIN_ID = "696df6b5ae596e708fe62a8b"; 
        const MASTER_KEY = "$2a$10$e0AwKK3h1YV3/kmqFxYITOPhqzvyD6OoCaTUZ6PzcRBfWJwpQInOW";
        const ADMIN_PASS = "admin789";

        // --- STATE ---
        let data = { routine:[], student:[], teacher:[], notice:[], attendance:[], polls:[], resources:[], subjects:[], crKeys:[] };
        let appState = { role: 'VIEWER', permissions: [] }; 
        let tempAttendance = new Set();

        // --- AUTH & PERMISSIONS ---
        function handleLogin() {
            if (appState.role !== 'VIEWER') {
                appState.role = 'VIEWER'; appState.permissions = [];
                renderAuthUI(); renderAll(); return;
            }
            let input = prompt("Enter Password (Master) or Access Key (CR):");
            if (!input) return;
            if (input === ADMIN_PASS) {
                appState.role = 'MASTER'; alert("‚úÖ Master Admin Logged In!");
            } else {
                let cr = data.crKeys.find(k => k.key === input);
                if (cr) { appState.role = 'CR'; appState.permissions = cr.permissions; alert(`‚úÖ Welcome CR! Access: ${cr.permissions.join(', ')}`); } 
                else { alert("‚ùå Invalid Credentials"); return; }
            }
            renderAuthUI(); renderAll();
        }

        function canEdit(section) {
            if (appState.role === 'MASTER') return true;
            if (appState.role === 'CR' && appState.permissions.includes(section)) return true;
            return false;
        }

        function renderAuthUI() {
            const btn = document.getElementById('admin-btn');
            const txt = document.getElementById('auth-text');
            const panel = document.getElementById('master-panel');
            if (appState.role === 'MASTER') {
                btn.className = 'admin-box active-mode'; txt.innerText = "Logout Master"; panel.style.display = 'block'; renderCRKeys();
            } else if (appState.role === 'CR') {
                btn.className = 'admin-box cr-mode'; txt.innerText = "Logout CR"; panel.style.display = 'none';
            } else {
                btn.className = 'admin-box'; txt.innerText = "Enable Admin"; panel.style.display = 'none';
            }
        }

        // --- CR MANAGEMENT ---
        function generateCRKey() {
            const name = document.getElementById('new-cr-name').value || 'Unknown';
            let perms = [];
            ['routine','notice','academic','student','teacher','attendance','polls'].forEach(p => { if(document.getElementById('perm-'+p).checked) perms.push(p); });
            if (perms.length === 0) return alert("Select at least one permission!");
            const key = "CR-" + Math.random().toString(36).substr(2, 6).toUpperCase();
            data.crKeys.push({ name: name, key: key, permissions: perms });
            saveData(); renderCRKeys(); alert(`Key Generated: ${key}`);
        }

        function deleteCRKey(index) { if(confirm("Revoke this key?")) { data.crKeys.splice(index, 1); saveData(); renderCRKeys(); } }

        function renderCRKeys() {
            const list = document.getElementById('cr-keys-list'); list.innerHTML = '';
            data.crKeys.forEach((k, i) => {
                list.innerHTML += `<div class="cr-list-item"><span><b>${k.name}</b> (${k.key})<br><small>${k.permissions.join(', ')}</small></span><button onclick="deleteCRKey(${i})" style="background:#ef4444;color:white;border:none;padding:2px 5px;border-radius:3px;cursor:pointer;">X</button></div>`;
            });
        }

        // --- IMAGE COMPRESSION ---
        function compressImage(file, callback) {
            const reader = new FileReader(); reader.readAsDataURL(file);
            reader.onload = event => {
                const img = new Image(); img.src = event.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const MAX_WIDTH = 600; const scaleSize = MAX_WIDTH / img.width;
                    if (img.width > MAX_WIDTH) { canvas.width = MAX_WIDTH; canvas.height = img.height * scaleSize; } else { canvas.width = img.width; canvas.height = img.height; }
                    const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    callback(canvas.toDataURL('image/jpeg', 0.7));
                }
            }
        }

        // --- DATA HANDLERS ---
        async function fetchData() {
            updateSyncStatus('loading');
            try {
                let res = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, { headers: { "X-Master-Key": MASTER_KEY } });
                if(!res.ok) throw new Error("API Error");
                let json = await res.json();
                data = { ...data, ...json.record };
                if(!data.crKeys) data.crKeys = [];
                renderAll(); updateSyncStatus('success');
            } catch(e) { updateSyncStatus('fail'); }
        }

        async function saveData() {
            updateSyncStatus('loading');
            try {
                await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, { method: "PUT", headers: { "Content-Type": "application/json", "X-Master-Key": MASTER_KEY }, body: JSON.stringify(data) });
                updateSyncStatus('success'); renderAll();
            } catch(e) { updateSyncStatus('fail'); alert("Save Failed!"); }
        }

        // --- RENDERERS ---
        function renderAll() {
            document.querySelectorAll('.admin-form').forEach(f => {
                const section = f.getAttribute('data-perm');
                if (f.id === 'att-controls') return; 
                f.style.display = canEdit(section) ? 'block' : 'none';
            });

            document.getElementById('att-controls').style.display = canEdit('attendance') ? 'block' : 'none';
            document.querySelectorAll('.action-col').forEach(e => e.style.display = canEdit('routine') ? 'table-cell' : 'none');

            // --- ROUTINE SPLIT ---
            const offBody = document.getElementById('routine-off-body');
            const onBody = document.getElementById('routine-on-body');
            offBody.innerHTML = ''; onBody.innerHTML = '';

            data.routine.forEach((i, x) => {
                const delBtn = canEdit('routine') ? `<button onclick="del('routine',${x})" style="color:red;border:none;background:none;cursor:pointer;">üóëÔ∏è</button>` : '';
                const row = `<tr><td><b>${i.day}</b></td><td>${i.sub}</td><td>${i.room}</td><td class="action-col">${delBtn}</td></tr>`;
                
                if (i.type === 'Online') onBody.innerHTML += row;
                else offBody.innerHTML += row;
            });

            // Students
            const stuL = document.getElementById('student-list'); stuL.innerHTML='';
            data.student.forEach((s,x) => {
                let img = s.img || 'https://cdn-icons-png.flaticon.com/512/3135/3135715.png';
                let btns = canEdit('student') ? `<button onclick="del('student',${x})" style="background:#ef4444; color:white; border:none; padding:5px 10px; border-radius:4px; float:right;">Delete</button>` : '';
                stuL.innerHTML += `<div class="card" style="display:flex; align-items:center; gap:15px;">
                    <img src="${img}" style="width:50px; height:50px; border-radius:50%; object-fit:cover; border:2px solid var(--active-bg);">
                    <div style="flex:1;"><h4 style="margin:0;">${s.name}</h4><small style="color:#64748b;">ID: ${s.id} | Dip: ${s.dip||'-'} | ${s.phone}</small></div>${btns}
                </div>`;
            });

            // Teachers
            const tL = document.getElementById('teacher-list'); tL.innerHTML='';
            data.teacher.forEach((t,x) => {
                let img = t.img || 'https://cdn-icons-png.flaticon.com/512/1995/1995539.png';
                let btns = canEdit('teacher') ? `<button onclick="del('teacher',${x})" style="float:right;color:red;background:none;border:none;">Del</button>` : '';
                tL.innerHTML += `<div class="card" style="display:flex; align-items:center; gap:15px;">
                    <img src="${img}" style="width:50px; height:50px; border-radius:50%; object-fit:cover; border:2px solid #334155;">
                    <div style="flex:1;"><b>${t.name}</b><br><small>${t.post}</small></div>${btns}
                </div>`;
            });

            // Notices
            const nList = document.getElementById('notice-list'); nList.innerHTML = '';
            data.notice.slice().reverse().forEach((n, x) => {
                let btns = canEdit('notice') ? `<button onclick="del('notice',${data.notice.length-1-x})" style="color:red; background:none; border:none; cursor:pointer; margin-top:5px;">Delete</button>` : '';
                nList.innerHTML += `<div class="card" style="border-left: 4px solid #3b82f6;"><b>${n.title}</b> <span style="font-size:0.75rem; float:right; color:#888;">${n.date}</span><p style="margin:5px 0 0; font-size:0.9rem; color:#475569;">${n.desc}</p>${btns}</div>`;
            });

            // Feed
            const feed = document.getElementById('activity-feed'); feed.innerHTML='';
            if(data.notice.length) {
                feed.innerHTML += `<div style="background:#dbeafe; padding:15px; border-radius:8px; border:1px solid #93c5fd; color:#1e40af; margin-bottom:15px;">üì¢ <b>Latest:</b> ${data.notice[data.notice.length-1].title}</div>`;
            }

            // Attendance
            const attH = document.getElementById('attendance-history'); attH.innerHTML='';
            data.attendance.slice().reverse().forEach((a,i) => {
                let ri = data.attendance.length - 1 - i;
                let btns = canEdit('attendance') ? `<button onclick="del('attendance',${ri})" style="color:red; background:none; border:none; cursor:pointer;">üóëÔ∏è</button>` : '';
                attH.innerHTML += `<div class="card" style="padding:15px; border-left:4px solid var(--active-bg);"><div style="display:flex; justify-content:space-between; align-items:center;"><div><b>${a.subject}</b> <small>(${a.date})</small><br><small>Present: ${a.presentIDs.length} / ${data.student.length}</small></div><div><button onclick="generatePDF(${ri})" style="background:#334155; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;">PDF</button> ${btns}</div></div></div>`;
            });

            // Att Grid
            const grid = document.getElementById('attendance-grid');
            if(grid.innerHTML === '') { data.student.forEach(s => { grid.innerHTML += `<div id="att-stu-${s.id}" class="att-student" onclick="toggleAttStatus('${s.id}')">${s.name}<br><small>${s.id}</small></div>`; }); }

            // Resources & Polls
            const rL=document.getElementById('resource-list'); rL.innerHTML=''; 
            data.resources.forEach((r,x)=>{ let btns = canEdit('academic') ? `<button onclick="del('resources',${x})" style="float:right;color:red;background:none;border:none;">Del</button>` : ''; rL.innerHTML+=`<div class="card"><a href="${r.url}" target="_blank" style="text-decoration:none; color:#2563eb; font-weight:bold;">üìÑ ${r.title}</a> ${btns}</div>` });

            const cList = document.getElementById('course-list'); cList.innerHTML = ''; 
            data.subjects.forEach((s,x)=>{ let btns = canEdit('academic') ? `<button onclick="del('subjects',${x})" style="float:right;color:red;background:none;border:none;">Del</button>` : ''; cList.innerHTML+=`<div class="card"><b>${s.name}</b> (${s.code}) <a href="${s.link}" target="_blank">Link</a> ${btns}</div>` });
            
            const pList = document.getElementById('poll-list'); pList.innerHTML = ''; 
            data.polls.forEach((p,x)=>{ let btns = canEdit('polls') ? `<button onclick="del('polls',${x})" style="float:right;color:red;background:none;border:none;">Del</button>` : ''; pList.innerHTML+=`<div class="card"><b>${p.question}</b> ${btns}</div>` });
        }

        // --- ACTIONS ---
        function toggleAttStatus(id) {
            const el = document.getElementById('att-stu-'+id);
            if(tempAttendance.has(id)) { tempAttendance.delete(id); el.classList.remove('present'); } else { tempAttendance.add(id); el.classList.add('present'); }
        }
        function selectAllAtt(state) {
            data.student.forEach(s => { const el = document.getElementById('att-stu-'+s.id); if(state) { tempAttendance.add(s.id); el.classList.add('present'); } else { tempAttendance.delete(s.id); el.classList.remove('present'); } });
        }
        function saveAttendance() {
            const d = document.getElementById('att-date').value; const s = document.getElementById('att-subject').value;
            if(!d || !s) return alert("Date & Subject Needed!");
            data.attendance.push({ date: d, subject: s, presentIDs: Array.from(tempAttendance) });
            tempAttendance.clear(); document.querySelectorAll('.att-student').forEach(e => e.classList.remove('present')); saveData();
        }

        function handleStudentSubmit() {
            const n=document.getElementById('s-name').value, i=document.getElementById('s-id').value, d=document.getElementById('s-dip').value, p=document.getElementById('s-phone').value, f=document.getElementById('s-img-file').files[0];
            if(!n) return alert("Name?");
            const saveS = (img) => { data.student.push({name:n, id:i, dip:d, phone:p, img:img}); resetStudentForm(); saveData(); };
            if(f) compressImage(f, (url) => saveS(url)); else saveS('');
        }
        function resetStudentForm() { document.querySelectorAll('#student-form input').forEach(i=>i.value=''); }

        function handleTeacherSubmit() {
            const n=document.getElementById('t-name').value, post=document.getElementById('t-post').value, ph=document.getElementById('t-phone').value, f=document.getElementById('t-img-file').files[0];
            if(!n) return alert("Name?");
            const saveT = (img) => { data.teacher.push({name:n, post:post, phone:ph, img:img}); document.querySelectorAll('#teacher-form input').forEach(i=>i.value=''); saveData(); };
            if(f) compressImage(f, (url) => saveT(url)); else saveT('');
        }

        function addRoutine(){ data.routine.push({type: document.getElementById('r-type').value, day:document.getElementById('r-day').value, sub:document.getElementById('r-sub').value, room:document.getElementById('r-room').value}); saveData(); }
        function addSubject(){ data.subjects.push({name:document.getElementById('sub-name').value, code:document.getElementById('sub-code').value, link:document.getElementById('sub-link').value}); saveData(); }
        function addResource(){ data.resources.push({title:document.getElementById('res-title').value, url:document.getElementById('res-url').value}); saveData(); }
        function addNotice(){ data.notice.push({date:document.getElementById('n-date').value, title:document.getElementById('n-title').value, desc:document.getElementById('n-desc').value}); saveData(); }
        function addPoll(){ data.polls.push({question:document.getElementById('poll-quest').value, options:document.getElementById('poll-opts').value.split(',')}); saveData(); }
        function del(key, idx) { if(confirm("Delete?")) { data[key].splice(idx,1); saveData(); } }
        
        function generatePDF(i) {
            const r = data.attendance[i]; const d = document.createElement('div');
            d.innerHTML = `<h2>Attendance: ${r.subject}</h2><p>Date: ${r.date}</p><hr><ul>${data.student.map(s => `<li style="color:${r.presentIDs.includes(s.id)?'green':'red'}">${s.name} (${s.id}) - ${r.presentIDs.includes(s.id)?'P':'A'}</li>`).join('')}</ul>`;
            html2pdf().from(d).save(`Att_${r.subject}.pdf`);
        }

        // --- UI HELPERS ---
        function showSection(id) {
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active-section'));
            document.getElementById(id).classList.add('active-section');
            document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
            document.getElementById('btn-'+id).classList.add('active');
            if(window.innerWidth < 768) toggleSidebar();
        }
        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); document.querySelector('.overlay').classList.toggle('active'); }
        function updateSyncStatus(status) {
            const dot = document.getElementById('sync-dot'); const txt = document.getElementById('sync-text');
            if(status === 'success') { dot.classList.add('online'); txt.innerText = "SYNC ACTIVE"; txt.style.color = "#22c55e"; } 
            else { dot.classList.remove('online'); txt.innerText = "SYNC FAILED"; txt.style.color = "#ef4444"; }
        }

        // INIT
        fetchData();
    </script>
</body>
</html>
