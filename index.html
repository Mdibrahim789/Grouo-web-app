<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UU EEE Dept App</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        /* --- THEME CSS --- */
        :root {
            --primary-color: #0f2027; 
            --secondary-color: #203a43; 
            --accent-color: #ffc107; 
            --text-light: #ecf0f1;
            --bg-color: #f0f2f5;
            --notice-bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0; padding: 0; padding-bottom: 80px;
            background-color: var(--bg-color); color: #333;
        }

        /* Header */
        header {
            background: linear-gradient(to right, #203a43, #2c5364);
            color: var(--text-light); padding: 15px; text-align: center;
            border-bottom: 4px solid var(--accent-color); position: relative;
        }
        header h1 { margin: 0; font-size: 1.4rem; letter-spacing: 1px; }
        header p { margin: 5px 0 0; font-size: 0.9rem; opacity: 0.9; }

        /* Status Indicator */
        #status-indicator {
            position: absolute; top: 10px; left: 10px;
            font-size: 0.7rem; padding: 4px 8px; border-radius: 12px;
            background: #e74c3c; color: white; display: flex; align-items: center; gap: 5px;
        }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: white; display: inline-block; }

        /* Admin Toggle */
        #admin-toggle {
            position: absolute; top: 15px; right: 15px;
            background: rgba(255,255,255,0.2); color: white; border: 1px solid white; 
            padding: 4px 8px; cursor: pointer; border-radius: 4px; font-size: 0.7rem;
        }

        /* Bottom Nav */
        nav {
            display: flex; justify-content: flex-start;
            background-color: var(--primary-color); padding: 8px 0;
            position: fixed; bottom: 0; width: 100%; z-index: 1000;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.2);
            overflow-x: auto; white-space: nowrap;
        }
        nav::-webkit-scrollbar { display: none; }
        nav button {
            background: none; border: none; color: #bdc3c7;
            font-size: 0.65rem; cursor: pointer; padding: 5px 15px;
            display: flex; flex-direction: column; align-items: center; min-width: 65px; flex-shrink: 0;
        }
        nav button span { font-size: 1.2rem; margin-bottom: 3px; }
        nav button.active { color: var(--accent-color); font-weight: bold; }

        /* Sections */
        .content-section { display: none; padding: 15px; max-width: 800px; margin: 0 auto; animation: fadeIn 0.4s; }
        .content-section.active-section { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Forms */
        .admin-form { display: none; background: white; padding: 15px; margin-bottom: 20px; border-radius: 8px; border-left: 5px solid var(--accent-color); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .admin-form input, .admin-form select, .admin-form textarea { padding: 10px; margin: 5px 0; width: 90%; border: 1px solid #ddd; border-radius: 4px; }
        .admin-form button { background: var(--secondary-color); color: var(--accent-color); border: none; padding: 10px; margin-top: 10px; width: 100%; font-weight: bold; cursor: pointer; }

        /* UI Elements */
        .section-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #ddd; padding-bottom: 5px; margin-bottom: 15px; }
        h2 { color: var(--secondary-color); margin: 0; }
        .print-btn { background: #34495e; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 0.8rem; }
        .delete-btn { background: #e74c3c; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor:pointer; font-size: 0.8rem;}
        .edit-btn { background: #f39c12; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor:pointer; font-size: 0.8rem; margin-right: 5px; }
        
        /* Tables & Cards */
        table { width: 100%; border-collapse: collapse; background: white; margin-top: 10px; font-size: 0.9rem; }
        th { background-color: var(--secondary-color); color: var(--accent-color); padding: 10px; text-align: left; }
        td { padding: 10px; border-bottom: 1px solid #ddd; }
        .card { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border-top: 3px solid var(--secondary-color); display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; position: relative;}

        /* Student Profile UI */
        .student-card-content { display: flex; align-items: center; }
        .student-img { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; border: 2px solid var(--accent-color); margin-right: 15px; background: #eee; }
        .phone-link { color: #2980b9; font-weight: bold; cursor: pointer; text-decoration: underline; }

        /* Notice Banner */
        .notice-banner { background: var(--notice-bg); color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(118, 75, 162, 0.4); }
        .nb-date { background: rgba(255,255,255,0.2); padding: 2px 8px; border-radius: 20px; font-size: 0.8rem; }
        .nb-title { font-size: 1.3rem; font-weight: bold; margin: 10px 0 5px; display: block; }

        /* Polls */
        .poll-card { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .poll-bar { height: 100%; background: rgba(255, 193, 7, 0.2); transition: width 0.5s ease; position: absolute; left: 0; top: 0; }
        .poll-option { background: #f8f9fa; border: 1px solid #ddd; padding: 10px; margin-bottom: 8px; border-radius: 6px; cursor: pointer; position: relative; overflow: hidden; }
        .poll-text { position: relative; z-index: 1; display: flex; justify-content: space-between; }
        .poll-voted .poll-option { cursor: not-allowed; opacity: 0.8; }
        .voted-badge { background: #27ae60; color: white; font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; float: right; }

        /* Dashboard */
        .activity-feed { margin-bottom: 30px; display: flex; flex-direction: column; gap: 10px; }
        .act-card { padding: 15px; border-radius: 8px; color: white; position: relative; overflow: hidden; cursor: pointer;}
        .act-notice { background: linear-gradient(135deg, #e74c3c, #c0392b); }
        .act-poll { background: linear-gradient(135deg, #f39c12, #d35400); }
        .act-attend { background: linear-gradient(135deg, #27ae60, #2ecc71); }

        /* Academic */
        .subject-card { background: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-left: 5px solid var(--secondary-color); }
        .progress-bar { height: 100%; background: linear-gradient(90deg, var(--secondary-color), var(--accent-color)); width: 0%; transition: width 0.5s; }
        .marks-container { display: none; margin-top: 15px; background: #f8f9fa; padding: 10px; border-radius: 8px; border: 1px dashed #bdc3c7; }
        .marks-input { width: 40px; padding: 4px; text-align: center; border: 1px solid #ddd; border-radius: 4px; font-size: 0.8rem;}
        .link-btn { background: #3498db; color: white; text-decoration: none; padding: 5px 10px; border-radius: 4px; font-size: 0.8rem; display: inline-block; }

    </style>
</head>
<body>

    <header>
        <div id="status-indicator">
            <span class="status-dot"></span> <span id="status-text">Offline</span>
        </div>

        <h1>Uttara University</h1>
        <p>Dept. of EEE | Batch 2026</p>
        <button id="admin-toggle" onclick="toggleAdminMode()">‚öôÔ∏è Admin</button>
    </header>

    <div id="home" class="content-section active-section">
        <div class="section-header"><h2>üî• Latest Updates</h2></div>
        <div id="activity-feed" class="activity-feed"></div>

        <div class="section-header">
            <h2>üìÖ Class Routine</h2>
            <button class="print-btn" onclick="downloadGeneralPDF('routine-table', 'Class_Routine')">üñ®Ô∏è PDF</button>
        </div>
        
        <div class="admin-form">
            <h3>Add Class</h3>
            <input type="text" id="r-day" placeholder="Day">
            <input type="text" id="r-sub" placeholder="Subject">
            <input type="text" id="r-room" placeholder="Room">
            <button onclick="addRoutine()">‚ûï Add Routine</button>
        </div>

        <table id="routine-table" style="margin-bottom: 30px;">
            <thead><tr><th>Day/Time</th><th>Subject</th><th class="action-col">Action</th></tr></thead>
            <tbody id="routine-body"></tbody>
        </table>
    </div>

    <div id="academic" class="content-section">
        <div class="admin-form">
            <h3>Add Course/Resource</h3>
            <input type="text" id="sub-name" placeholder="Subject Name">
            <input type="text" id="sub-code" placeholder="Code">
            <input type="text" id="sub-link" placeholder="Link">
            <button onclick="addSubject()">Add Course</button>
            <hr>
            <input type="text" id="res-title" placeholder="Resource Title">
            <input type="text" id="res-url" placeholder="Resource Link">
            <button onclick="addResource()">Add Resource</button>
        </div>
        <h2>üìò Active Courses</h2>
        <div id="course-list"></div>
        <h2 style="margin-top: 30px;">üìö Resources</h2>
        <div id="resource-list"></div>
    </div>

    <div id="students" class="content-section">
        <div class="admin-form" id="student-form">
            <h3>üéì Manage Student</h3>
            <input type="file" id="s-img-file" accept="image/*" style="margin-bottom:10px;">
            <input type="text" id="s-name" placeholder="Name">
            <input type="text" id="s-id" placeholder="ID">
            <input type="text" id="s-dip" placeholder="Dip. Session (e.g. 19-20)">
            <input type="text" id="s-phone" placeholder="Phone">
            <button id="btn-student-action" onclick="handleStudentSubmit()">‚ûï Add Student</button>
            <button onclick="resetStudentForm()" style="background:#7f8c8d; width:auto; margin-top:5px;">Cancel</button>
        </div>
        
        <div class="section-header">
            <h2>üéì Student List</h2> 
            <button class="print-btn" onclick="downloadGeneralPDF('student-list', 'Student_List')">üñ®Ô∏è PDF</button>
        </div>
        <div id="student-list"></div>
    </div>

    <div id="teachers" class="content-section">
        <div class="admin-form">
            <h3>Add Teacher</h3>
            <input type="text" id="t-name" placeholder="Name"><input type="text" id="t-post" placeholder="Post"><input type="text" id="t-phone" placeholder="Phone">
            <button onclick="addTeacher()">‚ûï Add Teacher</button>
        </div>
        <div class="section-header"><h2>üë®‚Äçüè´ Faculty</h2><button class="print-btn" onclick="downloadGeneralPDF('teacher-list', 'Faculty_List')">üñ®Ô∏è PDF</button></div>
        <div id="teacher-list"></div>
    </div>

    <div id="notice" class="content-section">
        <div class="admin-form">
            <h3>Post Notice</h3>
            <input type="date" id="n-date"><input type="text" id="n-title" placeholder="Title"><input type="text" id="n-desc" placeholder="Details">
            <button onclick="addNotice()">üì¢ Post Notice</button>
        </div>
        <h2>üîî Notice Board</h2>
        <div id="notice-list"></div>
    </div>

    <div id="attendance" class="content-section">
        <div class="admin-form" id="attendance-form-container">
            <h3>üìù Attendance</h3>
            <input type="date" id="att-date" style="background:#eee;">
            <input type="text" id="att-subject" placeholder="Subject" style="border: 2px solid var(--accent-color);">
            <div id="attendance-student-list" style="max-height: 200px; overflow-y: scroll; margin: 10px 0; border: 1px solid #ddd;"></div>
            <button onclick="saveAttendance()">üíæ Save</button>
        </div>
        <h2>üìä History</h2>
        <div id="attendance-history"></div>
    </div>

    <div id="polls" class="content-section">
        <div class="admin-form">
            <h3>üó≥Ô∏è Create Poll</h3>
            <input type="text" id="poll-quest" placeholder="Question">
            <textarea id="poll-opts" placeholder="Options separated by comma" rows="2"></textarea>
            <button onclick="addPoll()">‚úÖ Create Poll</button>
        </div>
        <h2>üó≥Ô∏è Active Polls</h2>
        <div id="poll-list"></div>
    </div>

    <nav>
        <button onclick="showSection('home')" class="active" id="btn-home"><span>üè†</span>Home</button>
        <button onclick="showSection('academic')" id="btn-academic"><span>üìò</span>Academic</button>
        <button onclick="showSection('students')" id="btn-students"><span>üë•</span>Students</button>
        <button onclick="showSection('teachers')" id="btn-teachers"><span>üë®‚Äçüè´</span>Faculty</button>
        <button onclick="showSection('notice')" id="btn-notice"><span>üîî</span>Notice</button>
        <button onclick="showSection('attendance')" id="btn-attendance"><span>üìù</span>Attend</button>
        <button onclick="showSection('polls')" id="btn-polls"><span>üó≥Ô∏è</span>Vote</button>
    </nav>

    <script>
        // GLOBAL NAV
        window.showSection = function(id) {
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active-section'));
            document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
            document.getElementById(id).classList.add('active-section');
            document.getElementById('btn-'+id).classList.add('active');
            window.scrollTo(0,0);
        };

        const BIN_ID = "696dd4ea43b1c97be93a1b9a";
        const MASTER_KEY = "$2a$10$KTYAb9AoPKihFgFBHUpPZ.w4pn1jq7NHptoZVp4iPFf3u0k6xmWly";
        const PREFIX = "uu_eee_hybrid_";

        // GLOBAL DATA
        let routineData=[], studentData=[], teacherData=[], noticeData=[], attendanceData=[], pollData=[], resourcesData=[], subjectData=[], marksData={};
        let isAdmin = false;
        let editStudentIndex = -1;
        let isOnline = false;

        // --- HYBRID DATA SYNC ---
        // 1. Load Local Data First (Instant Load)
        function loadLocalData() {
            try {
                routineData = JSON.parse(localStorage.getItem(PREFIX+'routine')) || [];
                studentData = JSON.parse(localStorage.getItem(PREFIX+'student')) || [];
                teacherData = JSON.parse(localStorage.getItem(PREFIX+'teacher')) || [];
                noticeData = JSON.parse(localStorage.getItem(PREFIX+'notice')) || [];
                attendanceData = JSON.parse(localStorage.getItem(PREFIX+'attendance')) || [];
                pollData = JSON.parse(localStorage.getItem(PREFIX+'polls')) || [];
                resourcesData = JSON.parse(localStorage.getItem(PREFIX+'resources')) || [];
                subjectData = JSON.parse(localStorage.getItem(PREFIX+'subjects')) || [];
                marksData = JSON.parse(localStorage.getItem(PREFIX+'marks')) || {};
            } catch(e) { console.log('Local Load Error'); }
            renderAll();
        }

        // 2. Fetch Server Data (Background)
        async function fetchServerData() {
            updateStatus(false);
            try {
                let res = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, {
                    headers: { "X-Master-Key": MASTER_KEY }
                });
                if(res.ok) {
                    let json = await res.json();
                    let d = json.record;
                    // Update variables
                    routineData = d.routine || [];
                    studentData = d.student || [];
                    teacherData = d.teacher || [];
                    noticeData = d.notice || [];
                    attendanceData = d.attendance || [];
                    pollData = d.polls || [];
                    resourcesData = d.resources || [];
                    subjectData = d.subjects || [];
                    marksData = d.marks || {};
                    
                    // Save to local for next time
                    saveToLocal(); 
                    renderAll();
                    updateStatus(true);
                }
            } catch(e) {
                console.log("Server fetch failed, running offline.");
                updateStatus(false);
            }
        }

        // 3. Save Function (Tries Server, Fallbacks to Local)
        async function saveData() {
            saveToLocal(); // Always save local first
            renderAll();   // Update UI immediately

            let payload = {
                routine: routineData, student: studentData, teacher: teacherData,
                notice: noticeData, attendance: attendanceData, polls: pollData,
                resources: resourcesData, subjects: subjectData, marks: marksData
            };

            try {
                let res = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, {
                    method: "PUT",
                    headers: { "Content-Type": "application/json", "X-Master-Key": MASTER_KEY },
                    body: JSON.stringify(payload)
                });
                if(res.ok) updateStatus(true);
                else updateStatus(false);
            } catch(e) {
                updateStatus(false); // Failed to sync
            }
        }

        function saveToLocal() {
            localStorage.setItem(PREFIX+'routine', JSON.stringify(routineData));
            localStorage.setItem(PREFIX+'student', JSON.stringify(studentData));
            localStorage.setItem(PREFIX+'teacher', JSON.stringify(teacherData));
            localStorage.setItem(PREFIX+'notice', JSON.stringify(noticeData));
            localStorage.setItem(PREFIX+'attendance', JSON.stringify(attendanceData));
            localStorage.setItem(PREFIX+'polls', JSON.stringify(pollData));
            localStorage.setItem(PREFIX+'resources', JSON.stringify(resourcesData));
            localStorage.setItem(PREFIX+'subjects', JSON.stringify(subjectData));
            localStorage.setItem(PREFIX+'marks', JSON.stringify(marksData));
        }

        function updateStatus(online) {
            isOnline = online;
            const ind = document.getElementById('status-indicator');
            const txt = document.getElementById('status-text');
            if(online) {
                ind.style.background = "#27ae60"; // Green
                txt.innerText = "Online (Synced)";
            } else {
                ind.style.background = "#e74c3c"; // Red
                txt.innerText = "Offline (Local)";
            }
        }

        // --- RENDERERS ---
        function renderAll() {
            // A. HOME
            const feed = document.getElementById('activity-feed'); feed.innerHTML = '';
            if(noticeData.length > 0) {
                const n = noticeData[noticeData.length - 1];
                feed.innerHTML += `<div class="notice-banner"><span class="nb-date">üìÖ ${n.date}</span><span class="nb-title">${n.title}</span><span class="nb-desc">${n.desc}</span></div>`;
            }
            if(pollData.length > 0) {
                const p = pollData[pollData.length - 1];
                feed.innerHTML += `<div class="act-card act-poll" onclick="showSection('polls')"><span class="act-title">üó≥Ô∏è Active Poll: ${p.question}</span><span class="act-meta">Click to vote</span></div>`;
            }

            const rBody = document.getElementById('routine-body'); rBody.innerHTML = '';
            routineData.forEach((i,x) => rBody.innerHTML += `<tr><td><b>${i.day}</b></td><td>${i.sub}<br><small>${i.room}</small></td><td class="action-col"><button class="delete-btn" onclick="del('routine',${x})">üóëÔ∏è</button></td></tr>`);

            // B. STUDENTS
            const stuL = document.getElementById('student-list'); stuL.innerHTML = '';
            studentData.forEach((s,x) => {
                const imgSrc = s.img ? s.img : 'https://cdn-icons-png.flaticon.com/512/3135/3135715.png';
                const adminControls = isAdmin ? `<div style="display:flex;flex-direction:column;gap:5px;margin-left:auto;"><button class="edit-btn" onclick="editStudent(${x})">‚úèÔ∏è</button><button class="delete-btn" onclick="del('student',${x})">üóëÔ∏è</button></div>` : '';
                stuL.innerHTML += `
                    <div class="card">
                        <div class="student-card-content">
                            <img src="${imgSrc}" class="student-img" alt="Photo">
                            <div class="student-info">
                                <h3>${s.name}</h3>
                                <p>ID: ${s.id} | Dip: <b>${s.dip||'-'}</b></p>
                                <p class="phone-link" onclick="copyText('${s.phone}')">üìû ${s.phone}</p>
                            </div>
                        </div>
                        ${adminControls}
                    </div>`;
            });

            // C. POLLS
            const pollL = document.getElementById('poll-list'); pollL.innerHTML=''; 
            pollData.slice().reverse().forEach((p,i)=>{
                const ri = pollData.length-1-i; 
                const tot = p.options.reduce((a,b)=>a+b.votes,0);
                const hasVoted = localStorage.getItem('voted_poll_'+ri);
                const votedClass = hasVoted ? 'poll-voted' : '';
                const votedBadge = hasVoted ? '<span class="voted-badge">Voted ‚úÖ</span>' : '';

                let opts = p.options.map((o,oi)=>`
                    <div class="poll-option" onclick="vote(${ri},${oi})">
                        <div class="poll-bar" style="width:${tot?Math.round((o.votes/tot)*100):0}%"></div>
                        <div class="poll-text"><span>${o.text}</span><span>${o.votes}</span></div>
                    </div>`).join('');
                pollL.innerHTML += `<div class="poll-card ${votedClass}"><b>${p.question}</b> ${votedBadge} ${opts}<button class="delete-btn" onclick="del('polls',${ri})" style="margin-top:5px;display:block;">End Poll</button></div>`;
            });

            // D. OTHERS
            renderOthers();
            updateAdminView();
        }

        function renderOthers() {
            const cList = document.getElementById('course-list'); cList.innerHTML = '';
            subjectData.forEach((sub, x) => {
                cList.innerHTML += `<div class="subject-card"><div style="display:flex;justify-content:space-between;"><div><b>${sub.name}</b><br><small>${sub.code}</small></div><a href="${sub.link}" class="link-btn" target="_blank">Syllabus</a></div><div style="background:#ecf0f1;height:10px;border-radius:5px;margin:10px 0;"><div class="progress-bar" style="width:${sub.progress}%"></div></div><div style="font-size:0.8rem;display:flex;justify-content:space-between;"><span>Status: <b>${sub.status}</b></span><span>${sub.progress}%</span></div><div class="admin-form" style="display:${isAdmin?'block':'none'};margin-top:5px;padding:0;background:none;box-shadow:none;"><input type="number" id="pv-${x}" value="${sub.progress}" style="width:40px"><input type="text" id="ps-${x}" value="${sub.status}" style="width:100px"><button onclick="updProg(${x})" style="width:auto;padding:3px;">Update</button><button onclick="del('subject',${x})" style="background:#e74c3c;color:white;border:none;padding:3px;margin-left:5px;">Del</button></div></div>`;
            });
            const resL = document.getElementById('resource-list'); resL.innerHTML=''; resourcesData.forEach((r,x)=> resL.innerHTML+=`<div class="card"><b>${r.title}</b><div><a href="${r.url}" target="_blank" class="link-btn">Open</a><button class="delete-btn" onclick="del('resources',${x})">üóëÔ∏è</button></div></div>`);
            const notL = document.getElementById('notice-list'); notL.innerHTML=''; noticeData.slice().reverse().forEach((n,x)=> notL.innerHTML+=`<div class="card" style="display:block;border-left:4px solid #e74c3c;"><b>${n.title}</b> <span style="font-size:0.7rem;background:#eee;padding:2px;">${n.date}</span><p style="margin:5px 0;font-size:0.9rem;">${n.desc}</p><button class="delete-btn" onclick="del('notice',${noticeData.length-1-x})" style="float:right;">Del</button><div style="clear:both;"></div></div>`);
            
            const tL = document.getElementById('teacher-list'); tL.innerHTML=''; teacherData.forEach((t,x)=> tL.innerHTML+=`<div class="card"><div><b>${t.name}</b><br><small>${t.post}</small></div><button class="delete-btn" onclick="del('teacher',${x})">üóëÔ∏è</button></div>`);
            const attList = document.getElementById('attendance-student-list'); attList.innerHTML=''; studentData.forEach(s=> attList.innerHTML+=`<div style="display:flex;justify-content:space-between;padding:5px;"><span>${s.name}</span><input type="checkbox" value="${s.id}" checked class="att-check"></div>`);
            const attH = document.getElementById('attendance-history'); attH.innerHTML=''; attendanceData.slice().reverse().forEach((a,i)=>{const ri=attendanceData.length-1-i; attH.innerHTML+=`<div class="card"><b>${a.subject}</b><br>${a.date} (P: ${a.presentIDs.length})<button class="delete-btn" onclick="del('attendance',${ri})" style="float:right">Del</button></div>`;});
        }

        // --- FUNCTIONS ---
        function handleStudentSubmit() {
            const n=v('s-name'), i=v('s-id'), d=v('s-dip'), p=v('s-phone');
            const fileInput = document.getElementById('s-img-file');
            if(!n) return alert("Name required");

            if(fileInput.files && fileInput.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) { saveStudentData(n, i, d, p, e.target.result); };
                reader.readAsDataURL(fileInput.files[0]);
            } else {
                const existingImg = (editStudentIndex !== -1) ? studentData[editStudentIndex].img : '';
                saveStudentData(n, i, d, p, existingImg);
            }
        }

        function saveStudentData(name, id, dip, phone, img) {
            if(editStudentIndex === -1) studentData.push({name, id, dip, phone, img});
            else studentData[editStudentIndex] = {name, id, dip, phone, img};
            resetStudentForm(); saveData();
        }

        function editStudent(index) {
            const s = studentData[index];
            document.getElementById('s-name').value = s.name;
            document.getElementById('s-id').value = s.id;
            document.getElementById('s-dip').value = s.dip || '';
            document.getElementById('s-phone').value = s.phone;
            editStudentIndex = index;
            document.getElementById('btn-student-action').innerText = "üíæ Update";
            document.getElementById('student-form').style.display = 'block';
            window.scrollTo(0,0);
        }

        function resetStudentForm() {
            document.querySelectorAll('#student-form input').forEach(i=>i.value='');
            editStudentIndex = -1;
            document.getElementById('btn-student-action').innerText = "‚ûï Add Student";
        }

        function copyText(text) { navigator.clipboard.writeText(text).then(() => alert("Copied: " + text)); }

        function vote(pi, oi) {
            if(localStorage.getItem('voted_poll_'+pi)) return alert("You have already voted!");
            pollData[pi].options[oi].votes++;
            localStorage.setItem('voted_poll_'+pi, 'true');
            saveData();
        }

        // --- UTILS ---
        function v(id){ return document.getElementById(id).value; }
        function toggleAdminMode() { isAdmin=!isAdmin; updateAdminView(); renderAll(); }
        function updateAdminView() {
            document.getElementById('admin-toggle').style.background=isAdmin?"#ffc107":"rgba(255,255,255,0.2)";
            document.querySelectorAll('.admin-form').forEach(e=>e.style.display=isAdmin?'block':'none');
            document.querySelectorAll('.delete-btn').forEach(e=>e.style.display=isAdmin?'inline-block':'none');
            document.querySelectorAll('.edit-btn').forEach(e=>e.style.display=isAdmin?'inline-block':'none');
            document.querySelectorAll('.action-col').forEach(e=>e.style.display=isAdmin?'table-cell':'none');
        }
        function pdf(id,n){ const e=document.getElementById(id); const w=document.createElement('div'); w.innerHTML='<h3 style="text-align:center">UU EEE</h3>'; w.appendChild(e.cloneNode(true)); html2pdf().from(w).save(n+'.pdf'); }
        function downloadGeneralPDF(id, n) { pdf(id,n); }

        function addRoutine(){ if(v('r-day')) { routineData.push({day:v('r-day'),sub:v('r-sub'),room:v('r-room')}); saveData(); } }
        function addSubject(){ if(v('sub-name')) { subjectData.push({name:v('sub-name'),code:v('sub-code'),link:v('sub-link'),progress:0,status:'Start'}); saveData(); } }
        function addResource(){ if(v('res-title')) { resourcesData.push({title:v('res-title'),url:v('res-url')}); saveData(); } }
        function addTeacher(){ if(v('t-name')) { teacherData.push({name:v('t-name'),post:v('t-post'),phone:v('t-phone')}); saveData(); } }
        function addNotice(){ if(v('n-title')) { noticeData.push({date:v('n-date'),title:v('n-title'),desc:v('n-desc')}); saveData(); } }
        function addPoll(){ if(v('poll-quest')) { pollData.push({question:v('poll-quest'),options:document.getElementById('poll-opts').value.split(',').map(t=>({text:t.trim(),votes:0}))}); saveData(); } }
        function saveAttendance(){ const d=v('att-date'); if(!d)return alert('Date?'); let p=[]; document.querySelectorAll('.att-check:checked').forEach(c=>p.push(c.value)); attendanceData.push({date:d,subject:v('att-subject'),presentIDs:p}); saveData(); }
        function updProg(x){ subjectData[x].progress=v(`pv-${x}`); subjectData[x].status=v(`ps-${x}`); saveData(); }

        function del(k,i) {
            if(!confirm('Sure?')) return;
            if(k=='student') studentData.splice(i,1); else if(k=='routine') routineData.splice(i,1);
            else if(k=='subjects') subjectData.splice(i,1); else if(k=='resources') resourcesData.splice(i,1);
            else if(k=='teacher') teacherData.splice(i,1); else if(k=='notice') noticeData.splice(i,1);
            else if(k=='attendance') attendanceData.splice(i,1); else if(k=='polls') pollData.splice(i,1);
            saveData();
        }

        // INIT
        loadLocalData();
        fetchServerData();
    </script>
</body>
</html>
